<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Ingahtzee! — StatsLG</title>
  <meta name="description" content="Pick custom dice for 3/10/25/100 rolls, compare sample means, submit to leaderboard."/>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/style/bctcstyle.css">
  <style>
    .wrap-grid{display:grid; grid-template-columns:360px 1fr; gap:1rem; align-items:start}
    .card{background:#fff; border:1px solid #cbd5e1; border-radius:12px; padding:1rem; box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .muted{color:#4b5563}
    .row{display:flex; gap:.5rem; align-items:center; flex-wrap:wrap}
    .row>*{margin:.15rem 0}
    .btn{cursor:pointer; border:1px solid #cbd5e1; background:#ffffff; color:#0f172a;
      border-radius:10px; padding:.55rem .9rem; font-weight:700; letter-spacing:.2px}
    .btn:hover{background:#f1f5f9}
    .btn.primary{background:#00467f; color:#ffffff; border-color:#00467f}
    .btn.primary:hover{filter:brightness(1.05)}
    .btn[disabled]{opacity:.6; cursor:not-allowed}
    .grid{display:grid; gap:.75rem}
    .grid.two{grid-template-columns:repeat(2,minmax(0,1fr))}
    .pill{display:inline-block; padding:.2rem .6rem; border-radius:999px; background:#f5f7fb; font-weight:700}
    .table{width:100%; border-collapse:collapse}
    .table th,.table td{border-bottom:1px solid #e5e7eb; padding:.5rem .25rem; text-align:center}
    .section-title{margin:.5rem 0 .25rem; font-weight:800}
    .faces{font-size:.95rem}
    .face-tag{display:inline-block; margin:.12rem; padding:.18rem .5rem; border:1px dashed #e5e7eb; border-radius:8px; background:#fff}
    .roller{width:110px; height:110px; border-radius:16px; border:1px solid #e5e7eb;
      display:grid; place-items:center; background:#fff; user-select:none; overflow:hidden}
    .roller.spin{animation:rollspin .6s ease-in-out infinite}
    @keyframes rollspin{0%{transform:rotate(0) scale(1)}50%{transform:rotate(90deg) scale(1.05)}100%{transform:rotate(180deg) scale(1)}}
    .bignum{font-size:48px; font-weight:800}
    .progress{height:8px; background:#e5e7eb; border-radius:999px; overflow:hidden}
    .progress>div{height:100%; width:0%; background:#00467f}
    .sel-grid{display:grid; grid-template-columns: 1fr auto; gap:.4rem .6rem; align-items:center}
    .sel-grid label{font-weight:700}
    select{padding:.45rem .55rem; border:1px solid #cbd5e1; border-radius:8px; color:#0f172a; background:#fff}
    .rolls-log{max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:.5rem}
    .roll-line{margin:.25rem 0; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace}
    .roll-line strong{display:inline-block; width:6.5rem}
    .chips{display:inline; word-break:break-word}
    .chip{display:inline-block; margin:.12rem .2rem; padding:.1rem .4rem; border:1px solid #e5e7eb; border-radius:6px}
    .lb-grid{display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:1rem}
    @media (max-width: 920px){ .wrap-grid{grid-template-columns:1fr} .lb-grid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<div class="wrap">
  <aside class="sidebar" aria-label="Site navigation" data-include="/partials/sidebar.html"></aside>

  <main class="wrap-grid">
    <!-- LEFT -->
    <section class="card">
      <header>
        <h1 class="h2">Ingahtzee!</h1>
        <p class="muted">Pick a die for each roll count (3 / 10 / 25 / 100). Faces are shown and are equally as likely. Then run and compare sample means.</p>
      </header>

      <div class="grid">
        <div class="row">
          <label for="player">Your name</label>
          <input id="player" type="text" placeholder="e.g., Alex M." style="flex:1; padding:.5rem .6rem; border-radius:8px; border:1px solid #cbd5e1; color:#0f172a; background:#fff"/>
        </div>

        <!-- Dice faces -->
        <div>
          <div class="section-title">Available dice (faces)</div>
          <div id="facesCatalog" class="faces muted small"></div>
        </div>

        <!-- Per-run die selectors -->
        <div>
          <div class="section-title">Choose a die for each run</div>
          <div class="sel-grid">
            <label for="sel3">3 rolls</label>
            <select id="sel3"></select>
            <label for="sel10">10 rolls</label>
            <select id="sel10"></select>
            <label for="sel25">25 rolls</label>
            <select id="sel25"></select>
            <label for="sel100">100 rolls</label>
            <select id="sel100"></select>
          </div>
          <div class="faces muted small" id="facesPreview" style="margin-top:.35rem;"></div>
        </div>

        <div class="grid two">
          <div class="roller" id="roller"><div class="bignum" id="rollNum">–</div></div>
          <div>
            <!-- Only Run All -->
            <div class="row">
              <button class="btn primary" id="runAllBtn">Run All (3→10→25→100)</button>
            </div>
            <div class="progress" aria-hidden="true"><div id="prog"></div></div>
          </div>
        </div>

        <div class="notice small">
          Prompt: “Predict which choices will give you the highest average for each number of rolls. After running, submit your scores to the leaderboard and see where you rank!.”
        </div>

        <div class="row right">
          <button class="btn primary" id="submitBtn" disabled>Submit to Leaderboard</button>
        </div>
        <p id="submitMsg" class="small muted"></p>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <h2 class="h4">Your Results</h2>
      <table class="table mono">
        <thead>
          <tr><th>3-roll die</th><th>10-roll die</th><th>25-roll die</th><th>100-roll die</th></tr>
        </thead>
        <tbody><tr>
          <td id="die3">—</td><td id="die10">—</td><td id="die25">—</td><td id="die100">—</td>
        </tr></tbody>
      </table>
      <table class="table mono" style="margin-top:.5rem">
        <thead>
          <tr><th>3-roll mean</th><th>10-roll mean</th><th>25-roll mean</th><th>100-roll mean</th></tr>
        </thead>
        <tbody><tr>
          <td id="m3">—</td><td id="m10">—</td><td id="m25">—</td><td id="m100">—</td>
        </tr></tbody>
      </table>

      <h3 class="h5" style="margin-top:.9rem">Rolls log</h3>
      <div class="rolls-log" id="rollsLog">
        <div class="roll-line"><strong>3 rolls:</strong> <span class="chips" id="rolls3">—</span></div>
        <div class="roll-line"><strong>10 rolls:</strong> <span class="chips" id="rolls10">—</span></div>
        <div class="roll-line"><strong>25 rolls:</strong> <span class="chips" id="rolls25">—</span></div>
        <div class="roll-line"><strong>100 rolls:</strong> <span class="chips" id="rolls100">—</span></div>
      </div>

      <!-- HIDDEN LEADERBOARD until submission -->
      <div id="leaderboardContainer" style="display:none;">
        <hr style="border:none; border-top:1px solid #e5e7eb; margin:.9rem 0"/>
        <h2 class="h4">Leaderboards</h2>

        <div class="lb-grid">
          <div><h3 class="h5">Top by 3-roll mean</h3><div class="leader-wrap" id="lb3"></div></div>
          <div><h3 class="h5">Top by 10-roll mean</h3><div class="leader-wrap" id="lb10"></div></div>
          <div><h3 class="h5">Top by 25-roll mean</h3><div class="leader-wrap" id="lb25"></div></div>
          <div><h3 class="h5">Top by 100-roll mean</h3><div class="leader-wrap" id="lb100"></div></div>
        </div>

        <div style="margin-top:1rem">
          <h3 class="h5">Best average rank (across 3/10/25/100)</h3>
          <div class="leader-wrap" id="lbAvg"></div>
          <p class="small muted" style="margin-top:.25rem">
            Average rank is computed from each submission’s place on the four leaderboards (1 = best). Missing a mean counts as the worst rank.
          </p>
        </div>

        <div class="row" style="margin-top:.5rem">
          <button class="btn" id="refreshBtn">Refresh Leaderboards</button>
          <span class="small muted">Each table is sorted by the corresponding metric.</span>
        </div>
      </div>
    </section>
  </main>
</div>

<script>
  // Sidebar include
  (function includePartials(){
    const inc = document.querySelector("[data-include]");
    if(!inc) return;
    fetch(inc.getAttribute("data-include"))
      .then(r=>r.text()).then(html=>{ inc.innerHTML = html; })
      .catch(()=>{});
  })();

  // Dice set (5 total)
  const DICE_5 = {
    "Die 1": [1, 2, 3, 4, 5, 6],
    "Die 2": [-10, -2, 10, 8, 8, 7],
    "Die 3": [-6, -1, 6, 6, 7, 8],
    "Die 4": [3, 3, 3, 4, 4, 4],
    "Die 5": [-5, -5, -5, -5, -5, 47]
  };
  const DIE_KEYS = Object.keys(DICE_5);

  // One-submission client lock (per browser)
  const SUBMIT_KEY = 'dice_submitted_v1';
  function markSubmitted() {
    localStorage.setItem(SUBMIT_KEY, '1');
    submitBtn.disabled = true;
    submitMsg.textContent = 'Submitted (one submission per student).';
    document.getElementById('leaderboardContainer').style.display = 'block';
    loadLeaderboards();
  }
  function restoreSubmitLock() {
    if (localStorage.getItem(SUBMIT_KEY) === '1') {
      submitBtn.disabled = true;
      submitMsg.textContent = 'You already submitted scores!';
      document.getElementById('leaderboardContainer').style.display = 'block';
      loadLeaderboards();
    }
  }

  // State
  const selectedDie = {3:null,10:null,25:null,100:null};
  const rollsByN = {3:null,10:null,25:null,100:null};
  const meansByN = {3:null,10:null,25:null,100:null};
  let rolling = false;

  // Elements
  const facesCatalog = document.getElementById('facesCatalog');
  const facesPreview = document.getElementById('facesPreview');
  const playerEl = document.getElementById('player');
  const submitBtn = document.getElementById('submitBtn');
  const submitMsg = document.getElementById('submitMsg');
  const progBar   = document.getElementById('prog');
  const rollerEl  = document.getElementById('roller');
  const rollNumEl = document.getElementById('rollNum');
  const runAllBtn = document.getElementById('runAllBtn');

  const die3El=document.getElementById('die3'),die10El=document.getElementById('die10'),
        die25El=document.getElementById('die25'),die100El=document.getElementById('die100'),
        m3El=document.getElementById('m3'),m10El=document.getElementById('m10'),
        m25El=document.getElementById('m25'),m100El=document.getElementById('m100'),
        rolls3El=document.getElementById('rolls3'),rolls10El=document.getElementById('rolls10'),
        rolls25El=document.getElementById('rolls25'),rolls100El=document.getElementById('rolls100');

  const sel3=document.getElementById('sel3'),sel10=document.getElementById('sel10'),
        sel25=document.getElementById('sel25'),sel100=document.getElementById('sel100');

  // Persist name
  playerEl.value = localStorage.getItem('dice_player_name') || '';
  playerEl.addEventListener('input', ()=> localStorage.setItem('dice_player_name', playerEl.value.trim()));

  // Build faces catalog
  function renderFacesCatalog(){
    facesCatalog.innerHTML = DIE_KEYS.map(k=>{
      const faces = DICE_5[k].map(v=>`<span class="face-tag">${v}</span>`).join('');
      return `<div class="small" style="margin:.25rem 0"><strong>${k}:</strong> ${faces}</div>`;
    }).join('');
  }

  // Fill selectors and preview
  function fillSelect(sel){
    sel.innerHTML = `<option value="">— choose a die —</option>` + DIE_KEYS.map(k=>`<option value="${k}">${k}</option>`).join('');
    sel.addEventListener('change', ()=>{
      const map={sel3:3,sel10:10,sel25:25,sel100:100};
      const n=map[sel.id];
      selectedDie[n]=sel.value||null;
      updateSelectedDieUI();
      showPreviewFor(n);
      checkSubmitEnabled();
    });
  }
  function showPreviewFor(n){
    const key=selectedDie[n];
    facesPreview.innerHTML = key
      ? `<span class="muted">Faces for ${n}-roll die (${key}):</span> ` + DICE_5[key].map(v=>`<span class="face-tag">${v}</span>`).join('')
      : '';
  }
  function updateSelectedDieUI(){
    die3El.textContent  = selectedDie[3]  || '—';
    die10El.textContent = selectedDie[10] || '—';
    die25El.textContent = selectedDie[25] || '—';
    die100El.textContent= selectedDie[100]|| '—';
  }
  function resetResults(){
    for (const k of [3,10,25,100]){rollsByN[k]=null;meansByN[k]=null;}
    [m3El,m10El,m25El,m100El].forEach(el=>el.textContent='—');
    [rolls3El,rolls10El,rolls25El,rolls100El].forEach(el=>el.textContent='—');
    checkSubmitEnabled();
  }
  function checkSubmitEnabled(){
    const hasAny = Object.values(meansByN).some(v=>v!=null);
    const already = localStorage.getItem(SUBMIT_KEY) === '1';
    submitBtn.disabled = !hasAny || already;
  }
  function chipsHTML(arr){return arr?arr.map(v=>`<span class="chip">${v}</span>`).join(''):'—';}
  function renderLogs(){
    rolls3El.innerHTML  = chipsHTML(rollsByN[3]);
    rolls10El.innerHTML = chipsHTML(rollsByN[10]);
    rolls25El.innerHTML = chipsHTML(rollsByN[25]);
    rolls100El.innerHTML= chipsHTML(rollsByN[100]);
  }
  function randFrom(arr){return arr[Math.floor(Math.random()*arr.length)];}
  function animateRollOnce(value){
    return new Promise(res=>{
      rollerEl.classList.add('spin');
      setTimeout(()=>{rollerEl.classList.remove('spin');rollNumEl.textContent=value;res();},420);
    });
  }

  async function runN(n){
    if(rolling) return;
    if(!selectedDie[n]){alert(`Choose a die for the ${n}-roll run first.`);return;}
    rolling=true; submitMsg.textContent=''; submitBtn.disabled=true;

    const faces=DICE_5[selectedDie[n]];
    const rolls=[]; let sum=0;
    progBar.style.width='0%';
    for(let i=1;i<=n;i++){
      const v=randFrom(faces);
      rolls.push(v); sum+=v;
      if(i<=10||i===n||i%Math.ceil(n/10)===0){await animateRollOnce(v);}
      progBar.style.width=((i/n)*100).toFixed(1)+'%';
    }
    const mean=+(sum/n).toFixed(3);
    meansByN[n]=mean; rollsByN[n]=rolls;

    if(n===3) m3El.textContent=mean;
    if(n===10) m10El.textContent=mean;
    if(n===25) m25El.textContent=mean;
    if(n===100) m100El.textContent=mean;
    renderLogs();
    checkSubmitEnabled();
    rolling=false;
  }

  async function runAll(){
    for (const n of [3,10,25,100]){
      if(!selectedDie[n]){ alert(`Choose a die for the ${n}-roll run first.`); return; }
    }
    await runN(3); await runN(10); await runN(25); await runN(100);
  }

  // Run All behavior:
  // - BEFORE submission: disable during run, stay disabled until they submit.
  // - AFTER  submission: never disable; just change text while running.
  runAllBtn.addEventListener('click', async ()=>{
    // validate selections
    for (const n of [3,10,25,100]){
      if (!selectedDie[n]) {
        alert(`Choose a die for the ${n}-roll run first.`);
        return;
      }
    }
    const alreadySubmitted = localStorage.getItem(SUBMIT_KEY) === '1';

    if (!alreadySubmitted) {
      runAllBtn.disabled = true;
    }
    const originalText = runAllBtn.textContent;
    runAllBtn.textContent = 'Running…';

    await runAll();

    if (!alreadySubmitted) {
      runAllBtn.textContent = 'Run complete — submit now';
      // stays disabled until a successful submission
    } else {
      runAllBtn.textContent = originalText; // reverts back and stays enabled
      runAllBtn.disabled = false;
    }
  });

  // Leaderboard (Apps Script)
  const GAS_URL = "https://script.google.com/macros/s/AKfycbzcd_m3_a8GjIsQFxNnlioG2zb_sibIZ18XB6WDPp9ovfyJnHTRZDUxreaIx0Ia9JgJuw/exec";

  async function submitLeaderboard(){
    const name = playerEl.value.trim();
    if(!name){ alert('Enter your name to submit.'); return; }

    const dieKeySummary = `3:${selectedDie[3]||'-'} | 10:${selectedDie[10]||'-'} | 25:${selectedDie[25]||'-'} | 100:${selectedDie[100]||'-'}`;

    const payload = {
      name,
      dieSet: 'per-run selection',
      dieKey: dieKeySummary,
      selectedDice: selectedDie,
      averages: meansByN,
      rolls: rollsByN,
      userAgent: navigator.userAgent,
      tzOffsetMinutes: new Date().getTimezoneOffset()
    };

    try{
      submitBtn.disabled = true;
      submitMsg.textContent = 'Submitting…';
      const resp = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: JSON.stringify(payload)
      });
      let data;
      try { data = await resp.json(); }
      catch { const raw = await resp.text(); console.log('Raw response:', raw); data = {}; }

      if (data && data.ok){
        submitMsg.textContent = 'Submitted! Loading leaderboards…';
        markSubmitted();

        // After submission: keep Run All permanently enabled for exploration
        runAllBtn.disabled = false;
        runAllBtn.textContent = 'Run All (3→10→25→100)';
      } else {
        submitMsg.textContent = 'Submission failed. Check backend URL / permissions.';
      }
    }catch(err){
      console.error(err);
      submitMsg.textContent = 'Network error submitting to leaderboard.';
    }finally{
      checkSubmitEnabled(); // respects submission lock
    }
  }
  document.getElementById('submitBtn').onclick = submitLeaderboard;

  // --- Leaderboards helpers (unchanged except rendering) ---
  function dieFor(dieKey, n){
    if(!dieKey) return '';
    const m = new RegExp(String(n).replace(/[.*+?^${}()|[\]\\]/g,'\\$&') + '\\s*:\\s*([^|]+)').exec(dieKey);
    return m ? m[1].trim() : '';
  }
  function renderTable(el, rows, headerHtml){
    if (!rows.length){ el.innerHTML = '<div class="small muted" style="padding:.5rem">No entries yet.</div>'; return; }
    let html = `<table class="table mono"><thead>${headerHtml}</thead><tbody>`;
    rows.forEach((r,i)=>{
      html += `<tr>
        <td>${i+1}</td>
        <td>${r.name || ''}</td>
        <td class="small">${r.valueDisplay ?? r.value ?? ''}</td>
        <td class="small muted">${r.when || ''}</td>
      </tr>`;
    });
    html += '</tbody></table>';
    el.innerHTML = html;
  }
  function buildRankMap(rows, metricKey){
    const withVal = rows
      .map((r, idx) => ({idx, val: parseFloat(r[metricKey])}))
      .filter(x => !Number.isNaN(x.val));
    withVal.sort((a,b)=> b.val - a.val);
    const rankMap = {};
    let currentRank = 0;
    let lastVal = null;
    withVal.forEach((x, pos) => {
      if (lastVal === null || x.val !== lastVal) {
        currentRank = pos + 1;
        lastVal = x.val;
      }
      rankMap[x.idx] = currentRank;
    });
    return { rankMap, countWithVal: withVal.length };
  }
  async function loadLeaderboards(){
    const targets = {3: lb3, 10: lb10, 25: lb25, 100: lb100, avg: lbAvg};
    for (const k in targets) targets[k].innerHTML = '<div class="small muted" style="padding:.5rem">Loading…</div>';
    try{
      const resp = await fetch(GAS_URL + '?top=500');
      let data; try { data = await resp.json(); } catch { data = {}; }
      const rows = (data && data.rows) ? data.rows : [];

      function renderMetric(n){
        const key = 'm' + n;
        const sorted = rows
          .filter(r => r[key] !== '' && r[key] != null && !Number.isNaN(parseFloat(r[key])))
          .map(r => ({
            name: r.name,
            when: r.when,
            metric: parseFloat(r[key]),
            die: dieFor(r.dieKey, n) || '',
          }))
          .sort((a,b)=> b.metric - a.metric)
          .slice(0, 20);

        if (!sorted.length){ targets[n].innerHTML = '<div class="small muted" style="padding:.5rem">No entries yet.</div>'; return; }

        let html = `<table class="table mono">
          <thead><tr><th>#</th><th>Name</th><th>Die (${n})</th><th>Mean(${n})</th><th class="small">When</th></tr></thead><tbody>`;
        sorted.forEach((r,i)=>{
          html += `<tr>
            <td>${i+1}</td>
            <td>${r.name || ''}</td>
            <td class="small">${r.die || ''}</td>
            <td><strong>${r.metric.toFixed(3)}</strong></td>
            <td class="small muted">${r.when || ''}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        targets[n].innerHTML = html;
      }
      renderMetric(3); renderMetric(10); renderMetric(25); renderMetric(100);

      const r3   = buildRankMap(rows, 'm3');
      const r10  = buildRankMap(rows, 'm10');
      const r25  = buildRankMap(rows, 'm25');
      const r100 = buildRankMap(rows, 'm100');

      const totalRows = rows.length;
      const worstRank = totalRows > 0 ? totalRows : 1;

      const withAvg = rows.map((r, idx) => {
        const rk3   = r3.rankMap[idx]   ?? worstRank;
        const rk10  = r10.rankMap[idx]  ?? worstRank;
        const rk25  = r25.rankMap[idx]  ?? worstRank;
        const rk100 = r100.rankMap[idx] ?? worstRank;
        const avgRank = (rk3 + rk10 + rk25 + rk100) / 4;
        return {
          name: r.name,
          when: r.when,
          value: avgRank,
          valueDisplay: `${avgRank.toFixed(2)}  (3:${rk3}, 10:${rk10}, 25:${rk25}, 100:${rk100})`
        };
      })
      .filter(x => !(Number.isNaN(parseFloat(rows.find(r=>r.name===x.name)?.m3)) &&
                     Number.isNaN(parseFloat(rows.find(r=>r.name===x.name)?.m10)) &&
                     Number.isNaN(parseFloat(rows.find(r=>r.name===x.name)?.m25)) &&
                     Number.isNaN(parseFloat(rows.find(r=>r.name===x.name)?.m100))))
      .sort((a,b)=> a.value - b.value)
      .slice(0, 20);

      renderTable(targets.avg, withAvg, `<tr><th>#</th><th>Name</th><th>Avg rank (details)</th><th class="small">When</th></tr>`);
    }catch(err){
      console.error(err);
      for (const k in targets) targets[k].innerHTML = '<div class="small muted" style="padding:.5rem)">Error loading leaderboard.</div>';
    }
  }

  // Init
  function init(){
    renderFacesCatalog();
    [sel3, sel10, sel25, sel100].forEach(fillSelect);
    resetResults();
    updateSelectedDieUI();
    restoreSubmitLock();
  }
  init();

  // Refresh button
  document.getElementById('refreshBtn').onclick = loadLeaderboards;
</script>
</body>
</html>
