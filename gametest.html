<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Variable Tamer — Sequential Wizard + Encounters</title>
  <!-- Brand stylesheet (placed in /style/bctcstyle.css) -->
  <link rel="stylesheet" href="style/bctcstyle.css" />
  <style>
    /* Minimal local layout/animation; colors/typography come from bctcstyle.css */
    .layout{ display:grid; grid-template-columns: var(--sidebar-w,280px) 1fr; min-height:100dvh }
    @media (max-width:760px){ .layout{ grid-template-columns:1fr } }
    main{ padding:24px; max-width:1100px }

    .stepper{ display:flex; gap:10px; margin:0 0 14px; flex-wrap:wrap }
    .step{ display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:10px; border:2px solid var(--rule); background: var(--card); }
    .step .dot{ width:22px; height:22px; border-radius:999px; display:grid; place-items:center; background: var(--kctcs-gold); color:#000; font-weight:800 }
    .step.active{ border-color: var(--kctcs-blue) }
    .step.done{ outline: 2px solid rgba(34,197,94,.35) }

    .screen{ position:relative; transform: translateY(8px); opacity:0; pointer-events:none; transition: opacity .22s ease, transform .22s ease }
    .screen.active{ transform: translateY(0); opacity:1; pointer-events:auto }

    .options{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.25rem }
    .pill{ padding:.5rem .75rem; border-radius:999px; border:1px solid var(--rule); cursor:pointer; user-select:none; background:transparent }
    .pill[aria-pressed="true"]{ outline:2px solid var(--kctcs-blue) }

    .feedback{ margin-top:.75rem; padding:.9rem; border-radius:10px; border:1px solid var(--rule); background: var(--panel) }
    .ok{ background: rgba(34,197,94,.10) }
    .bad{ background: rgba(239,68,68,.10) }

    .footer{ margin-top:.75rem; color: var(--muted); font-size:13px; display:flex; justify-content:space-between; gap:.75rem; flex-wrap:wrap }

    /* Overworld */
    .field{ position:relative; height:240px; overflow:hidden; background:var(--panel); border:1px solid var(--rule); display:grid; grid-template-columns:repeat(16, 1fr); grid-template-rows:repeat(10, 1fr) }
    .tile{ border:1px solid rgba(0,0,0,.04); }
    .grass{ background: linear-gradient(135deg, rgba(46,160,67,.18), rgba(46,160,67,.10)); }
    .path{ background: linear-gradient(135deg, rgba(140,95,60,.18), rgba(140,95,60,.10)); }
    .hero{ position:absolute; width:20px; height:20px; display:grid; place-items:center; font-size:16px; line-height:20px; transition: transform .12s ease; will-change: transform }
    .toast{ position:absolute; left:50%; top:8px; transform:translateX(-50%); background: var(--card); border:2px solid var(--kctcs-gold); padding:6px 10px; border-radius:10px; box-shadow:var(--shadow-2); font-weight:700 }

    /* --- Encounter FX --- */
    .encounter-overlay{ position:absolute; inset:0; pointer-events:none; display:grid; place-items:center; overflow:hidden; }
    .encounter-flash{ position:absolute; inset:0; background:radial-gradient(circle at center, rgba(231,166,20,.35), rgba(231,166,20,0) 60%); animation: flash 600ms ease-out forwards }
    .encounter-stripes{ position:absolute; inset:-20%; background:repeating-linear-gradient(45deg, rgba(0,70,127,.15) 0 14px, rgba(231,166,20,.18) 14px 28px); filter: blur(2px); animation: spin 900ms linear forwards }
    .shake{ animation: shake 500ms ease-in-out }
    @keyframes flash{ from{opacity:0} 30%{opacity:1} to{opacity:0} }
    @keyframes spin{ from{ transform: rotate(0deg) scale(1.1) } to{ transform: rotate(8deg) scale(1.05) } }
    @keyframes shake{ 0%,100%{ transform: translate(0,0) } 20%{ transform: translate(-3px, 1px) } 40%{ transform: translate(3px, -1px) } 60%{ transform: translate(-2px, 2px) } 80%{ transform: translate(2px, -2px) } }

    /* --- Win FX (confetti) --- */
    .confetti{ position:fixed; inset:0; pointer-events:none; overflow:hidden }
    .confetti i{ position:absolute; width:10px; height:16px; background: var(--kctcs-gold); transform: rotate(15deg); animation: fall 900ms ease-in forwards; opacity:.95 }
    .confetti i.alt{ background: var(--kctcs-blue); }
    @keyframes fall{ from{ transform: translateY(-20vh) rotate(0deg) } to{ transform: translateY(110vh) rotate(360deg) } }
  </style>
</head>
<body>
  <div class="layout">
    <aside id="sidebarMount" class="sidebar"></aside>
    <main>
      <header class="header">
        <h1>Variable Tamer</h1>
        <p class="text-muted">Walk around to find a random encounter, then complete the wizard: <strong>Type → Level → Graphs</strong>.</p>
      </header>

      <!-- Playfield / Overworld -->
      <section class="panel pad" id="overworld" aria-label="Overworld">
        <div class="row" style="align-items:center; margin-bottom:8px">
          <div class="checkline"><input id="encOn" type="checkbox" checked><label for="encOn"> Random encounters</label></div>
          <div class="text-muted">Use arrow keys / WASD to move. Step in tall grass for encounters.</div>
        </div>
        <div id="field" class="field round shadow-1" tabindex="0" role="application" aria-label="Overworld field"></div>
      </section>

      <div class="stepper">
        <div class="step active" id="s1"><div class="dot">1</div> Type</div>
        <div class="step" id="s2"><div class="dot">2</div> Level</div>
        <div class="step" id="s3"><div class="dot">3</div> Graphs</div>
      </div>

      <section class="card" id="game">
        <p id="prompt"><strong>A wild variable appears…</strong></p>

        <!-- STEP 1: TYPE -->
        <div class="screen active" id="stepType">
          <label>Variable Type</label>
          <select id="typeSelect">
            <option value="">— choose —</option>
            <option value="categorical">Categorical (Qualitative)</option>
            <option value="quant_discrete">Quantitative — Discrete</option>
            <option value="quant_continuous">Quantitative — Continuous</option>
          </select>
          <div class="row" style="margin-top:.6rem">
            <button class="btn" id="submitType">Submit Type (Enter)</button>
            <button class="btn ghost" id="revealType">Hint</button>
          </div>
          <div id="fbType"></div>
        </div>

        <!-- STEP 2: LEVEL -->
        <div class="screen" id="stepLevel">
          <label>Level of Measurement</label>
          <select id="levelSelect">
            <option value="">— choose —</option>
            <option value="nominal">Nominal</option>
            <option value="ordinal">Ordinal</option>
            <option value="interval">Interval</option>
            <option value="ratio">Ratio</option>
          </select>
          <div class="row" style="margin-top:.6rem">
            <button class="btn" id="submitLevel">Submit Level (Enter)</button>
            <button class="btn ghost" id="revealLevel">Hint</button>
          </div>
          <div id="fbLevel"></div>
        </div>

        <!-- STEP 3: GRAPHS -->
        <div class="screen" id="stepGraphs">
          <label>Choose all appropriate graph types</label>
          <div class="options" id="graphOptions" role="group" aria-label="Graph choices"></div>
          <div class="row" style="margin-top:.6rem">
            <button class="btn" id="submitGraphs">Submit Graphs (Enter)</button>
            <button class="btn ghost" id="revealGraphs">Hint</button>
          </div>
          <div id="fbGraphs"></div>
        </div>

        <!-- DONE / NEXT -->
        <div class="row" style="margin-top:1rem">
          <button class="btn outline" id="newVar">New Variable (N)</button>
          <button class="btn ghost" id="showExplain">Show Explanation</button>
        </div>
        <details class="panel pad" id="explainBox" style="margin-top:.6rem">
          <summary>Explanation</summary>
          <div id="explain"></div>
        </details>

        <div class="footer">
          <div>Keyboard: Enter = submit current step • N = new variable • 1–9 toggle graph choices</div>
        </div>
      </section>
    </main>
  </div>

  <script>
  // Load sidebar
  (async function(){
    try{
      const res = await fetch('partials/sidebar.html', {cache:'no-store'});
      if(res.ok){ const m=document.getElementById('sidebarMount'); if(m) m.innerHTML = await res.text(); }
    }catch(_){}}
  )();

  // ---- OVERWORLD (cute character + encounters) ----
  const field = document.getElementById('field');
  const encOn = document.getElementById('encOn');
  const COLS=16, ROWS=10;
  let grid=[]; let hero={x:8,y:5,el:null};
  function buildField(){
    if(!field) return;
    field.innerHTML=''; grid=[];
    for(let r=0;r<ROWS;r++){
      for(let c=0;c<COLS;c++){
        const d=document.createElement('div'); d.className='tile';
        const isGrass = (r>1 && r<ROWS-1 && c>1 && c<COLS-1 && Math.random()<0.6);
        d.classList.add(isGrass? 'grass':'path');
        field.appendChild(d);
        grid.push(isGrass? 'G':'P');
      }
    }
    const h=document.createElement('div'); h.className='hero'; h.textContent='🧑‍🏫'; field.appendChild(h); hero.el=h; placeHero();
  }
  function cellSize(){ return { cw: field.clientWidth/COLS, ch: field.clientHeight/ROWS }; }
  function placeHero(){ if(!hero.el) return; const {cw,ch}=cellSize(); hero.el.style.transform=`translate(${hero.x*cw}px, ${hero.y*ch}px)`; }
  function tileAt(x,y){ if(x<0||y<0||x>=COLS||y>=ROWS) return 'W'; return grid[y*COLS+x]; }
  function tryMove(dx,dy){ const nx=hero.x+dx, ny=hero.y+dy; if(tileAt(nx,ny)==='W') return; hero.x=nx; hero.y=ny; placeHero(); maybeEncounter(); }
  function maybeEncounter(){
    if(!encOn || !encOn.checked) return;
    if(tileAt(hero.x,hero.y)!=='G') return; // only grass
    if(Math.random()<0.20){
      showToast('A wild variable appears!');
      startEncounter();
    }
  }
  function showToast(msg){ const t=document.createElement('div'); t.className='toast'; t.textContent=msg; field.appendChild(t); setTimeout(()=>t.remove(),1200); }

  // --- Encounter/Win FX helpers ---
  function playEncounterFX(){
    if(!field) return;
    const ov = document.createElement('div'); ov.className='encounter-overlay';
    const stripes = document.createElement('div'); stripes.className='encounter-stripes';
    const flash = document.createElement('div'); flash.className='encounter-flash';
    ov.appendChild(stripes); ov.appendChild(flash); field.appendChild(ov);
    field.classList.add('shake');
    setTimeout(()=>{ field.classList.remove('shake'); ov.remove(); }, 700);
  }
  function playWinFX(){
    const layer = document.createElement('div'); layer.className='confetti';
    const n = 50; const w = window.innerWidth; const h = window.innerHeight;
    for(let i=0;i<n;i++){
      const p = document.createElement('i');
      p.style.left = (Math.random()*w) + 'px';
      p.style.top = (-Math.random()*h*0.3) + 'px';
      p.style.opacity = 0.8 + Math.random()*0.2;
      p.style.transform = `rotate(${Math.random()*180}deg)`;
      if(i%3===0) p.classList.add('alt');
      p.style.animationDelay = (Math.random()*0.2)+'s';
      layer.appendChild(p);
    }
    document.body.appendChild(layer);
    setTimeout(()=> layer.remove(), 1200);
  }

  function startEncounter(){
    playEncounterFX();
    setTimeout(()=>{
      pickNew();
      document.getElementById('game').scrollIntoView({behavior:'smooth'});
      setScreen(1);
    }, 650);
  }

  window.addEventListener('keydown',(e)=>{
    const k=e.key.toLowerCase();
    if(['arrowup','w'].includes(k)) { e.preventDefault(); tryMove(0,-1); }
    if(['arrowdown','s'].includes(k)) { e.preventDefault(); tryMove(0,1); }
    if(['arrowleft','a'].includes(k)) { e.preventDefault(); tryMove(-1,0); }
    if(['arrowright','d'].includes(k)) { e.preventDefault(); tryMove(1,0); }
  });

  // ---- BANK ----
  const BANK = [
    {prompt:"Favorite ice cream flavor", type:"categorical", level:"nominal", graphs:["bar","pareto","pie"], why:"Categories without order ⇒ nominal. Graph with bar/pareto; pie works if categories form a whole."},
    {prompt:"Class standing (freshman, sophomore, junior, senior)", type:"categorical", level:"ordinal", graphs:["bar","pareto"], why:"Ranked categories ⇒ ordinal. Bar/pareto respect ordering (avoid histogram: not numeric bins)."},
    {prompt:"Number of siblings", type:"quant_discrete", level:"ratio", graphs:["dot","hist","stem","box"], why:"Counts are discrete ratio (true zero & meaningful ratios). Dot plot/histogram/stem-and-leaf/box plot all work."},
    {prompt:"Weekly study hours", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot"], why:"Time is continuous ratio. Histogram/density/box; dot plot fine for small n."},
    {prompt:"Body temperature (°C)", type:"quant_continuous", level:"interval", graphs:["hist","density","box"], why:"°C has no true zero ⇒ interval."},
    {prompt:"Body temperature (K)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box"], why:"Kelvin has a true zero ⇒ ratio."},
    {prompt:"Jersey number", type:"categorical", level:"nominal", graphs:["bar","pareto","pie"], why:"Labels, not quantities. Treat as nominal categorical."},
    {prompt:"Finishing position in a race (1st, 2nd, 3rd, …)", type:"categorical", level:"ordinal", graphs:["bar","pareto"], why:"Ranks ⇒ ordinal."},
    {prompt:"Height (cm)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot","stem"], why:"Continuous ratio variable."},
    {prompt:"Age (years)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot"], why:"True zero and meaningful ratios."},
    {prompt:"Daily step count", type:"quant_discrete", level:"ratio", graphs:["hist","dot","box","stem"], why:"Counts ⇒ discrete ratio."},
    {prompt:"Satisfaction (Likert: 1–5)", type:"categorical", level:"ordinal", graphs:["bar","pareto"], why:"Likert items are ordinal."},
    {prompt:"Exam score (0–100)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot"], why:"Score behaves like ratio for most analyses."},
    {prompt:"Zip code", type:"categorical", level:"nominal", graphs:["bar","pareto","pie"], why:"Identifiers/labels ⇒ nominal."},
    {prompt:"Month of birth", type:"categorical", level:"nominal", graphs:["bar","pie","pareto"], why:"No inherent linear order."},
    {prompt:"Finish time in 5K (minutes)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot"], why:"Time is continuous ratio."},
    {prompt:"Temperature change from baseline (Δ°C)", type:"quant_continuous", level:"interval", graphs:["hist","density","box"], why:"Differences can be negative; interval scale."},
    {prompt:"Handedness (left/right)", type:"categorical", level:"nominal", graphs:["bar","pie","pareto"], why:"Binary categories ⇒ nominal."},
    {prompt:"Class period (1st, 2nd, …)", type:"categorical", level:"ordinal", graphs:["bar","pareto"], why:"Ordered categories."},
    {prompt:"Distance (meters)", type:"quant_continuous", level:"ratio", graphs:["hist","density","box","dot","stem"], why:"Physical measure with true zero."},
    {prompt:"Temperature (°F)", type:"quant_continuous", level:"interval", graphs:["hist","density","box"], why:"Fahrenheit lacks true zero ⇒ interval."},
    {prompt:"Shots made out of 10 attempts", type:"quant_discrete", level:"ratio", graphs:["dot","hist","box","stem"], why:"Counts (binomial)."}
  ];

  const GRAPH_CHOICES = [
    { id:"bar", label:"Bar chart (counts/percents)" },
    { id:"pareto", label:"Pareto (sorted bar)" },
    { id:"pie", label:"Pie chart" },
    { id:"hist", label:"Histogram" },
    { id:"density", label:"Density/curve" },
    { id:"dot", label:"Dot plot" },
    { id:"box", label:"Box plot" },
    { id:"stem", label:"Stem-and-leaf" },
  ];

  // --- State & DOM ---
  let current=null; let step=1;
  const $ = s=>document.querySelector(s);
  const promptEl = $('#prompt');
  const s1 = $('#s1'), s2 = $('#s2'), s3 = $('#s3');
  const stepType = $('#stepType'), stepLevel = $('#stepLevel'), stepGraphs = $('#stepGraphs');
  const fbType = $('#fbType'), fbLevel = $('#fbLevel'), fbGraphs = $('#fbGraphs');
  const typeSelect = $('#typeSelect'); const levelSelect = $('#levelSelect');
  const graphOptions = $('#graphOptions'); const explain = $('#explain'); const explainBox = $('#explainBox');

  function setScreen(n){
    step=n;
    stepType.classList.toggle('active', n===1);
    stepLevel.classList.toggle('active', n===2);
    stepGraphs.classList.toggle('active', n===3);
    s1.classList.toggle('active', n===1); s2.classList.toggle('active', n===2); s3.classList.toggle('active', n===3);
  }

  function pickNew(){
    current = BANK[Math.floor(Math.random()*BANK.length)];
    promptEl.innerHTML = `<strong>A wild variable appears:</strong> ${current.prompt}`;
    typeSelect.value=''; levelSelect.value='';
    fbType.innerHTML=''; fbLevel.innerHTML=''; fbGraphs.innerHTML='';
    explain.textContent=''; explainBox.open=false;
    [...graphOptions.children].forEach(x=>x.setAttribute('aria-pressed','false'));
    s1.classList.remove('done'); s2.classList.remove('done'); s3.classList.remove('done');
    setScreen(1);
  }

  function renderGraphPills(){
    graphOptions.innerHTML='';
    GRAPH_CHOICES.forEach((g, idx)=>{
      const btn = document.createElement('button');
      btn.className='pill'; btn.type='button';
      btn.setAttribute('role','switch'); btn.setAttribute('aria-pressed','false');
      btn.dataset.id = g.id; btn.textContent = `${idx+1}. ${g.label}`;
      btn.addEventListener('click', ()=>{
        const on = btn.getAttribute('aria-pressed')==='true';
        btn.setAttribute('aria-pressed', String(!on));
      });
      graphOptions.appendChild(btn);
    });
  }

  function setFeedback(el, ok, html){
    const div=document.createElement('div'); div.className = `feedback ${ok? 'ok':'bad'}`; div.innerHTML = html; el.innerHTML=''; el.appendChild(div);
  }

  function arraysEqualAsSets(a,b){
    if (a.length!==b.length) return false; const A=[...a].sort(); const B=[...b].sort();
    return A.every((v,i)=>v===B[i]);
  }

  function getSelectedGraphs(){
    return [...graphOptions.children].filter(x=>x.getAttribute('aria-pressed')==='true').map(x=>x.dataset.id);
  }

  // --- Step handlers ---
  function submitType(){
    const ans = typeSelect.value;
    if(!ans) { setFeedback(fbType, false, 'Pick a type.'); return; }
    if(ans === current.type){ setFeedback(fbType, true, 'Correct!'); s1.classList.add('done'); setScreen(2); }
    else { setFeedback(fbType, false, `Not quite. This variable is <b>${prettyType(current.type)}</b>.`); }
  }

  function submitLevel(){
    const ans = levelSelect.value;
    if(!ans) { setFeedback(fbLevel, false, 'Pick a level.'); return; }
    if(ans === current.level){ setFeedback(fbLevel, true, 'Correct!'); s2.classList.add('done'); setScreen(3); }
    else { setFeedback(fbLevel, false, `Not quite. The level is <b>${prettyLevel(current.level)}</b>.`); }
  }

  function submitGraphs(){
    const chosen = getSelectedGraphs();
    if(chosen.length===0){ setFeedback(fbGraphs, false, 'Choose at least one graph type.'); return; }
    const correct = current.graphs;
    if(arraysEqualAsSets(chosen, correct)){
      setFeedback(fbGraphs, true, 'Perfect! You tamed the variable.');
      s3.classList.add('done');
      explain.textContent = current.why; explainBox.open = true;
      playWinFX();
    } else {
      setFeedback(fbGraphs, false, `Close. Correct set: <b>${correct.map(prettyGraph).join(', ')}</b>.`);
    }
  }

  function prettyType(t){
    return t==='categorical' ? 'Categorical (Qualitative)'
      : t==='quant_discrete' ? 'Quantitative — Discrete'
      : 'Quantitative — Continuous';
  }
  function prettyLevel(l){ return l[0].toUpperCase()+l.slice(1); }
  function prettyGraph(id){ const f = GRAPH_CHOICES.find(g=>g.id===id); return f? f.label : id; }

  // Wire up
  renderGraphPills(); buildField(); // Encounter triggers pickNew()
  // pickNew() will be called from startEncounter();
  document.getElementById('submitType').addEventListener('click', submitType);
  document.getElementById('submitLevel').addEventListener('click', submitLevel);
  document.getElementById('submitGraphs').addEventListener('click', submitGraphs);
  document.getElementById('revealType').addEventListener('click', ()=> setFeedback(fbType, true, `Hint: ${current.why.split('.')[0]}.`));
  document.getElementById('revealLevel').addEventListener('click', ()=> setFeedback(fbLevel, true, `Hint: ${current.why.split('.')[0]}.`));
  document.getElementById('revealGraphs').addEventListener('click', ()=> setFeedback(fbGraphs, true, `Appropriate: ${current.graphs.map(prettyGraph).join(', ')}`));
  document.getElementById('newVar').addEventListener('click', pickNew);
  document.getElementById('showExplain').addEventListener('click', ()=>{ explain.textContent=current.why; explainBox.open=true; });

  // Keyboard: Enter submits current step; N = new; numbers toggle pills
  window.addEventListener('keydown', (e)=>{
    if(e.key==='Enter'){
      if(step===1) submitType(); else if(step===2) submitLevel(); else submitGraphs();
    }
    const k = e.key.toLowerCase();
    if(k==='n'){ pickNew(); }
    if(/^[1-9]$/.test(e.key)){
      if(step===3){ const idx = parseInt(e.key,10)-1; const btn = graphOptions.children[idx]; if(btn){ btn.click(); } }
    }
  });
  </script>
</body>
</html>
