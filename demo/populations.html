<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Population Mystery Sampler — StatsLG</title>
  <meta name="description" content="Students sample from 4 hidden populations and guess which distribution is which."/>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/style/bctcstyle.css">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    .wrap-grid{
      display:grid; grid-template-columns: 1fr; gap: 18px; align-items:start;
    }

    .panel{
      background: var(--panel, #f5f7fb);
      border: 1px solid var(--rule, #e5e7eb);
      border-radius: 12px;
      padding: 14px 16px;
    }

    .muted{color:var(--muted,#4b5563); font-size:0.95rem;}
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff; cursor:pointer; font-weight:600;
      text-decoration:none;
    }
    .btn.primary{
      background: var(--kctcs-blue,#00467f);
      color:#fff; border-color: transparent;
    }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    /* Card grid */
    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 14px;
    }
    @media (max-width: 900px){
      .cards{ grid-template-columns: 1fr; }
    }

    .pop-card{
      background: #fff;
      border: 1px solid var(--rule,#e5e7eb);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,0.03);
    }

    .pop-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 8px;
    }
    .pop-title{
      font-size: 1.05rem; font-weight: 800; margin: 0;
    }
    .badge{
      display:inline-block; padding: 2px 10px;
      border-radius: 999px; border: 1px solid var(--rule,#e5e7eb);
      font-variant-numeric: tabular-nums; background:#fff;
      font-weight:700;
    }
    .pop-body{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .plot{
      width:100%;
      height: 220px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      overflow:hidden;
      background:#fff;
    }

    .controls{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .controls > *{ flex: 1 1 160px; }

    select, input[type="number"]{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background:#fff;
    }

    .sample-box{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size: 0.95rem;
      padding: 10px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      background:#fff;
      max-height: 140px;
      overflow:auto;
      line-height: 1.35;
      white-space: pre-wrap;
    }

    .divider{ height:1px; background: var(--rule,#e5e7eb); margin: 10px 0; }
    .status{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff;
      font-weight: 700;
    }
    .status.good{ border-color: #86efac; }
    .status.bad{ border-color: #fca5a5; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar" aria-label="Site navigation" data-include="/partials/sidebar.html"></aside>

    <!-- ===== MAIN ===== -->
    <main>
      <header>
        <h1>Population Mystery Sampler</h1>
        <p class="subtitle">
          Click <strong>Take sample</strong> on each card. Use the sample + mini-histogram to guess which population distribution each card represents.
        </p>
      </header>

      <div class="wrap-grid">
        <!-- Global Controls -->
        <section class="panel" aria-label="Game controls">
          <div class="row">
            <div>
              <label for="n" style="display:block;font-weight:700;margin-bottom:6px;">Sample size (per draw)</label>
              <input id="n" type="number" min="1" max="200" value="12" />
              <div class="muted" style="margin-top:6px;">Tip: Start small (n=5–15). Then increase (n=30+) to see patterns stabilize.</div>
            </div>

            <div>
              <label for="seed" style="display:block;font-weight:700;margin-bottom:6px;">Random seed (optional)</label>
              <input id="seed" type="number" placeholder="Leave blank for random" />
              <div class="muted" style="margin-top:6px;">Use a seed to make the same mystery mapping repeatable.</div>
            </div>

            <div style="align-self:end;">
              <div class="row" style="gap:10px;">
                <button class="btn" id="newRound">New round</button>
                <button class="btn primary" id="check">Check answers</button>
                <button class="btn" id="reveal">Reveal</button>
                <button class="btn" id="resetSamples">Reset samples</button>
              </div>
              <div id="scoreBox" class="muted" style="margin-top:10px;"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">
            <strong>Teacher note:</strong> The identities are shuffled each round.
            Students only see “Population A–D” until you click Reveal.
          </div>
        </section>

        <!-- Cards -->
        <section class="panel" aria-label="Populations">
          <div class="cards" id="cards"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // --------- Sidebar include ----------
    document.querySelectorAll('[data-include]').forEach(el=>{
      fetch(el.getAttribute('data-include'))
        .then(r=>r.text()).then(html=>{ el.innerHTML = html; });
    });

    // ============================================================
    // 1) Define your 4 population "true identities" here
    //    You can edit names + generators.
    // ============================================================
    const POP_TYPES = [
      {
        key: "normal",
        label: "Normal (bell-shaped)",
        hint: "Symmetric, centered.",
        gen: (rng) => {
          // Box-Muller standard normal, then scale
          const z = randn(rng);
          return 50 + 10*z; // mean 50, sd 10
        }
      },
      {
        key: "rightSkew",
        label: "Right-skewed",
        hint: "Many small/moderate values, few large ones.",
        gen: (rng) => {
          // Exponential-like then shift
          const u = rng();
          const x = -Math.log(1-u); // Exp(1)
          return 30 + 12*x; // shift/scale
        }
      },
      {
        key: "bimodal",
        label: "Bimodal",
        hint: "Two clusters / two peaks.",
        gen: (rng) => {
          // Mixture of two normals
          const choose = rng() < 0.5;
          const z = randn(rng);
          return choose ? (35 + 6*z) : (65 + 6*z);
        }
      },
      {
        key: "uniform",
        label: "Uniform",
        hint: "Roughly flat across a range.",
        gen: (rng) => {
          return 20 + 80*rng(); // Uniform(20,100)
        }
      }
    ];

    // ============================================================
    // 2) UI/game state
    // ============================================================
    const cardLabels = ["A","B","C","D"];
    const cardsEl = document.getElementById('cards');
    const nInput = document.getElementById('n');
    const seedInput = document.getElementById('seed');
    const scoreBox = document.getElementById('scoreBox');

    const btnNewRound = document.getElementById('newRound');
    const btnCheck = document.getElementById('check');
    const btnReveal = document.getElementById('reveal');
    const btnResetSamples = document.getElementById('resetSamples');

    let rng = Math.random;
    let round = null; // { mapping: [{card:'A', pop:POP_TYPES[i]}...], samplesByCard: {A:[], ...}, revealed:boolean }

    // ============================================================
    // RNG with seed (Mulberry32)
    // ============================================================
    function mulberry32(seed){
      let a = seed >>> 0;
      return function(){
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    // Standard normal using Box-Muller
    function randn(rng){
      let u = 0, v = 0;
      while(u === 0) u = rng();
      while(v === 0) v = rng();
      return Math.sqrt(-2*Math.log(u)) * Math.cos(2*Math.PI*v);
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rng()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function fmt(x){
      const ax = Math.abs(x);
      if (ax !== 0 && (ax < 1e-3 || ax > 1e6)) return x.toExponential(3);
      return x.toFixed(2).replace(/\.00$/,'');
    }

    // ============================================================
    // Build card DOM
    // ============================================================
    function buildCards(){
      cardsEl.innerHTML = "";
      cardLabels.forEach(letter=>{
        const card = document.createElement('article');
        card.className = "pop-card";
        card.id = `card-${letter}`;

        card.innerHTML = `
          <div class="pop-head">
            <div>
              <h3 class="pop-title">Population ${letter}</h3>
              <div class="muted" id="truth-${letter}" style="display:none;"></div>
            </div>
            <span class="badge" id="count-${letter}">samples: 0</span>
          </div>

          <div class="pop-body">
            <div class="plot" id="plot-${letter}" aria-label="Sample histogram"></div>

            <div class="controls">
              <button class="btn primary" data-action="sample" data-card="${letter}">Take sample</button>

              <select data-action="guess" data-card="${letter}">
                <option value="">Select your guess…</option>
                ${POP_TYPES.map(p=>`<option value="${p.key}">${p.label}</option>`).join('')}
              </select>

              <button class="btn" data-action="clear" data-card="${letter}">Clear</button>
            </div>

            <div class="sample-box" id="box-${letter}" aria-label="Sample values">No samples yet.</div>
          </div>
        `;
        cardsEl.appendChild(card);
      });

      // Button handlers via event delegation
      cardsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const action = btn.dataset.action;
        const letter = btn.dataset.card;
        if(!action || !letter) return;

        if(action === "sample") takeSample(letter);
        if(action === "clear") clearCard(letter);
      });

      cardsEl.addEventListener('change', (e)=>{
        const sel = e.target.closest('select');
        if(!sel) return;
        const letter = sel.dataset.card;
        if(!letter) return;
        round.guessByCard[letter] = sel.value;
      });
    }

    // ============================================================
    // Round logic
    // ============================================================
    function newRound(){
      // set RNG
      const seedVal = seedInput.value.trim();
      if(seedVal === ""){
        rng = Math.random;
      }else{
        rng = mulberry32(parseInt(seedVal,10) || 1);
      }

      // shuffle POP_TYPES to cards A-D
      const shuffled = shuffle(POP_TYPES);
      const mapping = cardLabels.map((letter, i)=>({card: letter, pop: shuffled[i]}));

      round = {
        mapping,
        samplesByCard: {A:[],B:[],C:[],D:[]},
        guessByCard: {A:"",B:"",C:"",D:""},
        revealed: false
      };

      scoreBox.innerHTML = "";
      buildCards();
      cardLabels.forEach(letter=>{
        drawHistogram(letter);
        updateSampleBox(letter);
        updateTruthLabel(letter);
      });
    }

    function resetSamples(){
      if(!round) return;
      round.samplesByCard = {A:[],B:[],C:[],D:[]};
      cardLabels.forEach(letter=>{
        drawHistogram(letter);
        updateSampleBox(letter);
        document.getElementById(`count-${letter}`).textContent = "samples: 0";
      });
      scoreBox.innerHTML = `<span class="muted">Samples cleared.</span>`;
    }

    function clearCard(letter){
      round.samplesByCard[letter] = [];
      drawHistogram(letter);
      updateSampleBox(letter);
      document.getElementById(`count-${letter}`).textContent = "samples: 0";
    }

    function takeSample(letter){
      const n = Math.max(1, Math.min(200, parseInt(nInput.value,10) || 1));
      const pop = round.mapping.find(m=>m.card===letter).pop;
      const newVals = [];
      for(let i=0;i<n;i++){
        newVals.push(pop.gen(rng));
      }
      round.samplesByCard[letter].push(...newVals);
      document.getElementById(`count-${letter}`).textContent = `samples: ${round.samplesByCard[letter].length}`;
      updateSampleBox(letter);
      drawHistogram(letter);
    }

    function updateSampleBox(letter){
      const box = document.getElementById(`box-${letter}`);
      const arr = round.samplesByCard[letter];
      if(arr.length === 0){
        box.textContent = "No samples yet.";
        return;
      }
      // Show last 30 values for readability
      const last = arr.slice(-30).map(fmt);
      const more = arr.length > 30 ? `\n… (${arr.length-30} earlier values hidden)` : "";
      box.textContent = last.join(", ") + more;
    }

    // ============================================================
    // Plotly histogram per card
    // ============================================================
    function drawHistogram(letter){
      const div = document.getElementById(`plot-${letter}`);
      const dataArr = round.samplesByCard[letter];

      const trace = {
        type: 'histogram',
        x: dataArr,
        nbinsx: 12,
        opacity: 0.75,
        hovertemplate: "bin count=%{y}<extra></extra>"
      };

      const layout = {
        margin: {t: 10, r: 10, b: 30, l: 40},
        xaxis: {title: "value"},
        yaxis: {title: "count"},
        showlegend: false
      };

      Plotly.react(div, [trace], layout, {responsive:true});
    }

    // ============================================================
    // Reveal + Check
    // ============================================================
    function updateTruthLabel(letter){
      const el = document.getElementById(`truth-${letter}`);
      const pop = round.mapping.find(m=>m.card===letter).pop;
      el.innerHTML = `<strong>Identity:</strong> ${pop.label} <span class="muted">(${pop.hint})</span>`;
      el.style.display = round.revealed ? "" : "none";
    }

    function reveal(){
      round.revealed = true;
      cardLabels.forEach(updateTruthLabel);
      scoreBox.innerHTML = `<span class="status">Revealed. Use “New round” to reshuffle.</span>`;
    }

    function checkAnswers(){
      let correct = 0;
      const details = [];

      cardLabels.forEach(letter=>{
        const guess = round.guessByCard[letter];
        const truth = round.mapping.find(m=>m.card===letter).pop.key;
        const ok = (guess && guess === truth);
        if(ok) correct++;
        details.push({letter, ok, guess, truth});
      });

      // Pretty output
      const total = cardLabels.length;
      const pct = Math.round((correct/total)*100);
      const lines = details.map(d=>{
        const g = d.guess ? POP_TYPES.find(p=>p.key===d.guess)?.label : "(no guess)";
        const t = POP_TYPES.find(p=>p.key===d.truth)?.label;
        return `Population ${d.letter}: ${d.ok ? "✅" : "❌"}  guess: ${g}  |  truth: ${t}`;
      }).join("<br/>");

      scoreBox.innerHTML = `
        <div class="status ${correct===total ? "good" : "bad"}">
          Score: ${correct} / ${total} (${pct}%)
        </div>
        <div class="muted" style="margin-top:8px;line-height:1.5">
          ${lines}
        </div>
      `;
    }

    // ============================================================
    // Buttons
    // ============================================================
    btnNewRound.addEventListener('click', newRound);
    btnResetSamples.addEventListener('click', resetSamples);
    btnReveal.addEventListener('click', reveal);
    btnCheck.addEventListener('click', checkAnswers);

    // Initial
    newRound();
    window.addEventListener('resize', ()=>{
      cardLabels.forEach(letter=>{
        const div = document.getElementById(`plot-${letter}`);
        if(div) Plotly.Plots.resize(div);
      });
    });
  </script>
</body>
</html>
