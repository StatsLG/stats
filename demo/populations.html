<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Demographics Mystery Sampler — StatsLG</title>
  <meta name="description" content="Students sample from 4 hidden demographic distributions and guess which is which."/>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/style/bctcstyle.css">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    .wrap-grid{ display:grid; grid-template-columns: 1fr; gap: 18px; align-items:start; }
    .panel{
      background: var(--panel, #f5f7fb);
      border: 1px solid var(--rule, #e5e7eb);
      border-radius: 12px;
      padding: 14px 16px;
    }
    .muted{color:var(--muted,#4b5563); font-size:0.95rem;}
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > *{ flex: 1 1 auto; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff; cursor:pointer; font-weight:600;
      text-decoration:none;
    }
    .btn.primary{
      background: var(--kctcs-blue,#00467f);
      color:#fff; border-color: transparent;
    }
    .btn:disabled{ opacity:0.5; cursor:not-allowed; }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 14px;
    }
    @media (max-width: 900px){ .cards{ grid-template-columns: 1fr; } }

    .pop-card{
      background: #fff;
      border: 1px solid var(--rule,#e5e7eb);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,0.03);
    }
    .pop-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 8px;
    }
    .pop-title{ font-size: 1.05rem; font-weight: 800; margin: 0; }
    .badge{
      display:inline-block; padding: 2px 10px;
      border-radius: 999px; border: 1px solid var(--rule,#e5e7eb);
      font-variant-numeric: tabular-nums; background:#fff;
      font-weight:700;
    }

    .plot{
      width:100%;
      height: 230px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      overflow:hidden;
      background:#fff;
    }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .controls > *{ flex: 1 1 170px; }
    select, input[type="number"]{
      width: 100%;
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background:#fff;
    }

    table{
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border:1px solid var(--rule,#e5e7eb);
      border-radius: 12px;
      overflow:hidden;
    }
    th, td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--rule,#e5e7eb);
      text-align:left;
      font-variant-numeric: tabular-nums;
    }
    th{ background: #fafafa; font-weight:800; }
    tr:last-child td{ border-bottom: none; }

    .divider{ height:1px; background: var(--rule,#e5e7eb); margin: 10px 0; }
    .status{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff;
      font-weight: 700;
    }
    .status.good{ border-color: #86efac; }
    .status.bad{ border-color: #fca5a5; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- ===== SIDEBAR ===== -->
    <aside class="sidebar" aria-label="Site navigation" data-include="/partials/sidebar.html"></aside>

    <!-- ===== MAIN ===== -->
    <main>
      <header>
        <h1>Demographics Mystery Sampler</h1>
        <p class="subtitle">
          Each card is a different <strong>hidden demographic distribution</strong>.
          Take samples, inspect the category counts, and guess which profile each card matches.
        </p>
      </header>

      <div class="wrap-grid">
        <!-- Global Controls -->
        <section class="panel" aria-label="Game controls">
          <div class="row">
            <div>
              <label for="n" style="display:block;font-weight:700;margin-bottom:6px;">Sample size (per draw)</label>
              <input id="n" type="number" min="1" max="500" value="25" />
              <div class="muted" style="margin-top:6px;">
                Tip: Try n=10, then n=30, then n=100. Bigger samples stabilize proportions.
              </div>
            </div>

            <div>
              <label for="seed" style="display:block;font-weight:700;margin-bottom:6px;">Random seed (optional)</label>
              <input id="seed" type="number" placeholder="Leave blank for random" />
              <div class="muted" style="margin-top:6px;">Use a seed to replay the same shuffle for a section.</div>
            </div>

            <div style="align-self:end;">
              <div class="row" style="gap:10px;">
                <button class="btn" id="newRound">New round</button>
                <button class="btn primary" id="check">Check answers</button>
                <button class="btn" id="reveal">Reveal</button>
                <button class="btn" id="resetSamples">Reset samples</button>
              </div>
              <div id="scoreBox" class="muted" style="margin-top:10px;"></div>
            </div>
          </div>

          <div class="divider"></div>

          <div class="muted">
            <strong>What they’re seeing:</strong> samples from a categorical distribution (multinomial sampling).
            Each card accumulates samples as you click “Take sample”.
          </div>
        </section>

        <!-- Cards -->
        <section class="panel" aria-label="Populations">
          <div id="dimensionTitle" class="muted" style="margin-bottom:10px;"></div>
          <div class="cards" id="cards"></div>
        </section>
      </div>
    </main>
  </div>

  <script>
    // --------- Sidebar include ----------
    document.querySelectorAll('[data-include]').forEach(el=>{
      fetch(el.getAttribute('data-include'))
        .then(r=>r.text()).then(html=>{ el.innerHTML = html; });
    });

    // ============================================================
    // EDIT HERE: Choose your demographic dimension + categories,
    // and define 4 profiles with different category proportions.
    //
    // Proportions can be any positive numbers; they will be normalized.
    // ============================================================

    const DEMO = {
      dimensionLabel: "Primary Work Status",
      categories: [
        "Not working",
        "Part-time (1–20 hrs)",
        "Part-time (21–30 hrs)",
        "Full-time (31+ hrs)"
      ],
      profiles: [
        {
          key: "mostly-not-working",
          label: "Profile 1: Mostly not working",
          hint: "Large share in 'Not working'.",
          weights: [55, 25, 12, 8]
        },
        {
          key: "mostly-full-time",
          label: "Profile 2: Mostly full-time work",
          hint: "Large share in 'Full-time (31+ hrs)'.",
          weights: [10, 18, 22, 50]
        },
        {
          key: "mostly-part-time",
          label: "Profile 3: Mostly part-time work",
          hint: "Most students in part-time categories.",
          weights: [15, 45, 30, 10]
        },
        {
          key: "balanced",
          label: "Profile 4: Balanced mix",
          hint: "No category dominates.",
          weights: [25, 25, 25, 25]
        }
      ]
    };

    // ============================================================
    // Game state / UI
    // ============================================================
    const cardLabels = ["A","B","C","D"];
    const cardsEl = document.getElementById('cards');
    const nInput = document.getElementById('n');
    const seedInput = document.getElementById('seed');
    const scoreBox = document.getElementById('scoreBox');
    const dimensionTitle = document.getElementById('dimensionTitle');

    const btnNewRound = document.getElementById('newRound');
    const btnCheck = document.getElementById('check');
    const btnReveal = document.getElementById('reveal');
    const btnResetSamples = document.getElementById('resetSamples');

    dimensionTitle.innerHTML = `<strong>Demographic variable:</strong> ${escapeHtml(DEMO.dimensionLabel)} (categories shown as counts).`;

    let rng = Math.random;
    let round = null; // { mapping, countsByCard, nByCard, guessByCard, revealed }

    // ============================================================
    // RNG with seed (Mulberry32)
    // ============================================================
    function mulberry32(seed){
      let a = seed >>> 0;
      return function(){
        a |= 0; a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(rng()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    // Normalize weights -> probabilities
    function normalize(weights){
      const sum = weights.reduce((a,b)=>a + Math.max(0,b), 0);
      if(sum <= 0) return weights.map(_=>1/weights.length);
      return weights.map(w => Math.max(0,w)/sum);
    }

    // Draw one categorical outcome using probabilities
    function drawCategoryIndex(probs){
      const u = rng();
      let cum = 0;
      for(let i=0;i<probs.length;i++){
        cum += probs[i];
        if(u <= cum) return i;
      }
      return probs.length - 1; // fallback for floating error
    }

    // ============================================================
    // Build UI cards
    // ============================================================
    function buildCards(){
      cardsEl.innerHTML = "";
      cardLabels.forEach(letter=>{
        const card = document.createElement('article');
        card.className = "pop-card";
        card.id = `card-${letter}`;

        card.innerHTML = `
          <div class="pop-head">
            <div>
              <h3 class="pop-title">Population ${letter}</h3>
              <div class="muted" id="truth-${letter}" style="display:none;"></div>
            </div>
            <span class="badge" id="nBadge-${letter}">N = 0</span>
          </div>

          <div class="plot" id="plot-${letter}" aria-label="Bar chart of category counts"></div>

          <div class="controls" style="margin-top:10px;">
            <button class="btn primary" data-action="sample" data-card="${letter}">Take sample</button>

            <select data-action="guess" data-card="${letter}">
              <option value="">Select your guess…</option>
              ${DEMO.profiles.map(p=>`<option value="${p.key}">${escapeHtml(p.label)}</option>`).join('')}
            </select>

            <button class="btn" data-action="clear" data-card="${letter}">Clear</button>
          </div>

          <div style="margin-top:10px;">
            <table aria-label="Counts table">
              <thead>
                <tr>
                  <th>Category</th>
                  <th>Count</th>
                  <th>Percent</th>
                </tr>
              </thead>
              <tbody id="tbl-${letter}"></tbody>
            </table>
          </div>
        `;
        cardsEl.appendChild(card);
      });

      // Event delegation
      cardsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const action = btn.dataset.action;
        const letter = btn.dataset.card;
        if(!action || !letter) return;

        if(action === "sample") takeSample(letter);
        if(action === "clear") clearCard(letter);
      });

      cardsEl.addEventListener('change', (e)=>{
        const sel = e.target.closest('select');
        if(!sel) return;
        const letter = sel.dataset.card;
        if(!letter) return;
        round.guessByCard[letter] = sel.value;
      });
    }

    // ============================================================
    // Round setup
    // ============================================================
    function newRound(){
      // set RNG
      const seedVal = seedInput.value.trim();
      if(seedVal === ""){
        rng = Math.random;
      }else{
        rng = mulberry32(parseInt(seedVal,10) || 1);
      }

      // assign profiles randomly to cards A-D
      const shuffledProfiles = shuffle(DEMO.profiles);
      const mapping = cardLabels.map((letter, i)=>({
        card: letter,
        profile: shuffledProfiles[i],
        probs: normalize(shuffledProfiles[i].weights)
      }));

      // initialize counts
      const countsByCard = {};
      const nByCard = {};
      cardLabels.forEach(letter=>{
        countsByCard[letter] = new Array(DEMO.categories.length).fill(0);
        nByCard[letter] = 0;
      });

      round = {
        mapping,
        countsByCard,
        nByCard,
        guessByCard: {A:"",B:"",C:"",D:""},
        revealed: false
      };

      scoreBox.innerHTML = "";
      buildCards();
      cardLabels.forEach(letter=>{
        renderCard(letter);
        updateTruthLabel(letter);
      });
    }

    function resetSamples(){
      if(!round) return;
      cardLabels.forEach(letter=>{
        round.countsByCard[letter] = new Array(DEMO.categories.length).fill(0);
        round.nByCard[letter] = 0;
        renderCard(letter);
      });
      scoreBox.innerHTML = `<span class="muted">All samples cleared.</span>`;
    }

    function clearCard(letter){
      round.countsByCard[letter] = new Array(DEMO.categories.length).fill(0);
      round.nByCard[letter] = 0;
      renderCard(letter);
    }

    function takeSample(letter){
      const n = Math.max(1, Math.min(500, parseInt(nInput.value,10) || 1));
      const m = round.mapping.find(x=>x.card===letter);
      const probs = m.probs;

      for(let i=0;i<n;i++){
        const idx = drawCategoryIndex(probs);
        round.countsByCard[letter][idx] += 1;
        round.nByCard[letter] += 1;
      }
      renderCard(letter);
    }

    // ============================================================
    // Rendering per card (Plot + table)
    // ============================================================
    function renderCard(letter){
      const counts = round.countsByCard[letter];
      const N = round.nByCard[letter];

      document.getElementById(`nBadge-${letter}`).textContent = `N = ${N}`;

      // Plotly bar chart of counts
      const div = document.getElementById(`plot-${letter}`);
      const trace = {
        type: 'bar',
        x: DEMO.categories,
        y: counts,
        hovertemplate: "%{x}<br>count=%{y}<extra></extra>",
        opacity: 0.85
      };

      const layout = {
        margin: {t: 10, r: 10, b: 70, l: 45},
        xaxis: {tickangle: -20},
        yaxis: {title: "count", rangemode: "tozero"},
        showlegend: false
      };

      Plotly.react(div, [trace], layout, {responsive:true});

      // Table
      const tbody = document.getElementById(`tbl-${letter}`);
      tbody.innerHTML = "";
      for(let i=0;i<DEMO.categories.length;i++){
        const c = counts[i];
        const pct = (N === 0) ? 0 : (100*c/N);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(DEMO.categories[i])}</td>
          <td>${c}</td>
          <td>${pct.toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // ============================================================
    // Reveal + Check
    // ============================================================
    function updateTruthLabel(letter){
      const el = document.getElementById(`truth-${letter}`);
      const m = round.mapping.find(x=>x.card===letter);
      el.innerHTML = `<strong>Identity:</strong> ${escapeHtml(m.profile.label)} <span class="muted">(${escapeHtml(m.profile.hint)})</span>`;
      el.style.display = round.revealed ? "" : "none";
    }

    function reveal(){
      round.revealed = true;
      cardLabels.forEach(updateTruthLabel);
      scoreBox.innerHTML = `<span class="status">Revealed. Use “New round” to reshuffle.</span>`;
    }

    function checkAnswers(){
      let correct = 0;
      const details = [];

      cardLabels.forEach(letter=>{
        const guess = round.guessByCard[letter];
        const truth = round.mapping.find(m=>m.card===letter).profile.key;
        const ok = (guess && guess === truth);
        if(ok) correct++;
        details.push({letter, ok, guess, truth});
      });

      const total = cardLabels.length;
      const pct = Math.round((correct/total)*100);

      const labelOf = (key) => DEMO.profiles.find(p=>p.key===key)?.label || "(no guess)";
      const lines = details.map(d=>{
        return `Population ${d.letter}: ${d.ok ? "✅" : "❌"} &nbsp; guess: ${escapeHtml(labelOf(d.guess))} &nbsp; | &nbsp; truth: ${escapeHtml(labelOf(d.truth))}`;
      }).join("<br/>");

      scoreBox.innerHTML = `
        <div class="status ${correct===total ? "good" : "bad"}">
          Score: ${correct} / ${total} (${pct}%)
        </div>
        <div class="muted" style="margin-top:8px;line-height:1.5">
          ${lines}
        </div>
      `;
    }

    // ============================================================
    // Buttons
    // ============================================================
    btnNewRound.addEventListener('click', newRound);
    btnResetSamples.addEventListener('click', resetSamples);
    btnReveal.addEventListener('click', reveal);
    btnCheck.addEventListener('click', checkAnswers);

    // Initial
    newRound();

    // Resize
    window.addEventListener('resize', ()=>{
      cardLabels.forEach(letter=>{
        const div = document.getElementById(`plot-${letter}`);
        if(div) Plotly.Plots.resize(div);
      });
    });
  </script>
</body>
</html>
