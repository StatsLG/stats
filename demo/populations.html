<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cats vs Dogs — City Mystery Sampler</title>
  <meta name="description" content="Students sample from 4 hidden city populations (cats vs dogs preferences) and guess which city is which."/>
  <link rel="icon" href="/favicon.ico"/>
  <link rel="stylesheet" href="/style/bctcstyle.css">

  <!-- Plotly -->
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>

  <style>
    .panel{
      background: var(--panel, #f5f7fb);
      border: 1px solid var(--rule, #e5e7eb);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 14px;
    }
    .muted{color:var(--muted,#4b5563); font-size:0.95rem;}
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center;
      padding: 10px 12px; border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff; cursor:pointer; font-weight:600;
      text-decoration:none;
    }
    .btn.primary{
      background: var(--kctcs-blue,#00467f);
      color:#fff; border-color: transparent;
    }

    .cards{
      display:grid;
      grid-template-columns: repeat(2, minmax(280px, 1fr));
      gap: 14px;
    }
    @media (max-width: 900px){ .cards{ grid-template-columns: 1fr; } }

    .pop-card{
      background: #fff;
      border: 1px solid var(--rule,#e5e7eb);
      border-radius: 14px;
      padding: 14px;
      box-shadow: 0 1px 0 rgba(15,23,42,0.03);
    }
    .pop-head{
      display:flex; align-items:flex-start; justify-content:space-between; gap: 10px;
      margin-bottom: 8px;
    }
    .pop-title{ font-size: 1.05rem; font-weight: 800; margin: 0; }
    .badge{
      display:inline-block; padding: 2px 10px;
      border-radius: 999px; border: 1px solid var(--rule,#e5e7eb);
      font-variant-numeric: tabular-nums; background:#fff;
      font-weight:700;
    }
    .plot{
      width:100%;
      height: 200px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      overflow:hidden;
      background:#fff;
    }
    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }
    .controls > *{ flex: 1 1 160px; }

    select, input[type="number"]{
      padding: 10px 10px;
      border-radius: 10px;
      border: 1px solid var(--rule,#e5e7eb);
      background:#fff;
    }

    table{
      width:100%;
      border-collapse: collapse;
      background:#fff;
      border:1px solid var(--rule,#e5e7eb);
      border-radius: 12px;
      overflow:hidden;
      margin-top:10px;
    }
    th, td{
      padding: 8px 10px;
      border-bottom: 1px solid var(--rule,#e5e7eb);
      text-align:left;
      font-variant-numeric: tabular-nums;
    }
    th{ background: #fafafa; font-weight:800; }
    tr:last-child td{ border-bottom: none; }

    .status{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--rule,#e5e7eb);
      background: #fff;
      font-weight: 700;
      margin-top: 12px;
    }
    .status.good{ border-color: #86efac; }
    .status.bad{ border-color: #fca5a5; }
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Sidebar include (keeps your site consistent) -->
    <aside class="sidebar" aria-label="Site navigation" data-include="/partials/sidebar.html"></aside>

    <main>
      <header>
        <h1>Cats vs Dogs — City Mystery Sampler</h1>
        <p class="subtitle">
          Each card is a <strong>hidden city</strong>. Sample residents and guess which city each card represents.
        </p>
      </header>

      <!-- Simple top bar -->
      <section class="panel" aria-label="Top controls">
        <div class="row">
          <div>
            <label for="n" style="display:block;font-weight:800;margin-bottom:6px;">Sample size</label>
            <input id="n" type="number" min="1" max="500" value="25" />
            <div class="muted" style="margin-top:6px;">Try 10 → 25 → 100 to see how hard 51/49 is to detect.</div>
          </div>
          <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap;">
            <button class="btn" id="newRound">New round</button>
            <button class="btn" id="reveal">Reveal</button>
          </div>
        </div>

        <div id="revealNote" class="muted" style="margin-top:10px;"></div>
      </section>

      <!-- Cards -->
      <section class="panel" aria-label="City cards">
        <div class="cards" id="cards"></div>

        <div class="row" style="margin-top:12px;">
          <button class="btn primary" id="check">Check answers</button>
          <button class="btn" id="resetSamples">Reset samples</button>
        </div>
        <div id="scoreBox"></div>
      </section>
    </main>
  </div>

  <script>
    // Sidebar include
    document.querySelectorAll('[data-include]').forEach(el=>{
      fetch(el.getAttribute('data-include'))
        .then(r=>r.text()).then(html=>{ el.innerHTML = html; });
    });

    // ============================================================
    // DEMO: Cats vs Dogs by City (hidden)
    // ============================================================
    const DEMO = {
      dimensionLabel: "Preference: Cats vs Dogs (by City)",
      categories: ["Cats", "Dogs"],
      profiles: [
        { key:"city-austin",     label:"Austin, TX",     hint:"Very strong Cats preference.",   weights:[80,20] },
        { key:"city-chicago",    label:"Chicago, IL",    hint:"Balanced.",                      weights:[50,50] },
        { key:"city-lexington",  label:"Lexington, KY",  hint:"Almost balanced, slightly Cats.",weights:[51,49] },
        { key:"city-sanantonio", label:"San Antonio, TX",hint:"Very strong Dogs preference.",   weights:[20,80] }
      ]
    };

    const cardLabels = ["A","B","C","D"];
    const cardsEl = document.getElementById('cards');
    const nInput = document.getElementById('n');
    const scoreBox = document.getElementById('scoreBox');
    const revealNote = document.getElementById('revealNote');

    const btnNewRound = document.getElementById('newRound');
    const btnReveal = document.getElementById('reveal');
    const btnCheck = document.getElementById('check');
    const btnResetSamples = document.getElementById('resetSamples');

    let round = null; // { mapping, probsByCard, countsByCard, nByCard, guessByCard, revealed }

    function escapeHtml(s){
      return String(s)
        .replace(/&/g,'&amp;')
        .replace(/</g,'&lt;')
        .replace(/>/g,'&gt;')
        .replace(/"/g,'&quot;')
        .replace(/'/g,'&#039;');
    }

    function shuffle(arr){
      const a = arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function normalize(weights){
      const sum = weights.reduce((a,b)=>a + Math.max(0,b), 0);
      if(sum <= 0) return weights.map(_=>1/weights.length);
      return weights.map(w => Math.max(0,w)/sum);
    }

    function drawCategoryIndex(probs){
      const u = Math.random();
      let cum = 0;
      for(let i=0;i<probs.length;i++){
        cum += probs[i];
        if(u <= cum) return i;
      }
      return probs.length - 1;
    }

    function buildCards(){
      cardsEl.innerHTML = "";
      cardLabels.forEach(letter=>{
        const card = document.createElement('article');
        card.className = "pop-card";
        card.id = `card-${letter}`;

        card.innerHTML = `
          <div class="pop-head">
            <div>
              <h3 class="pop-title">City ${letter}</h3>
              <div class="muted" id="truth-${letter}" style="display:none;"></div>
            </div>
            <span class="badge" id="nBadge-${letter}">N = 0</span>
          </div>

          <div class="plot" id="plot-${letter}" aria-label="Bar chart of category counts"></div>

          <div class="controls">
            <button class="btn primary" data-action="sample" data-card="${letter}">Take sample</button>

            <select data-action="guess" data-card="${letter}">
              <option value="">Guess the city…</option>
              ${DEMO.profiles.map(p=>`<option value="${p.key}">${escapeHtml(p.label)}</option>`).join('')}
            </select>

            <button class="btn" data-action="clear" data-card="${letter}">Clear</button>
          </div>

          <table aria-label="Counts table">
            <thead>
              <tr><th>Preference</th><th>Count</th><th>Percent</th></tr>
            </thead>
            <tbody id="tbl-${letter}"></tbody>
          </table>
        `;
        cardsEl.appendChild(card);
      });

      // Button clicks
      cardsEl.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if(!btn) return;
        const action = btn.dataset.action;
        const letter = btn.dataset.card;
        if(!action || !letter) return;

        if(action === "sample") takeSample(letter);
        if(action === "clear") clearCard(letter);
      });

      // Guess dropdowns
      cardsEl.addEventListener('change', (e)=>{
        const sel = e.target.closest('select');
        if(!sel) return;
        const letter = sel.dataset.card;
        if(!letter) return;
        round.guessByCard[letter] = sel.value;
      });
    }

    function newRound(){
      const shuffled = shuffle(DEMO.profiles);
      const mapping = cardLabels.map((letter, i)=>({ card: letter, profile: shuffled[i] }));

      const probsByCard = {};
      const countsByCard = {};
      const nByCard = {};
      cardLabels.forEach(letter=>{
        const prof = mapping.find(m=>m.card===letter).profile;
        probsByCard[letter] = normalize(prof.weights);
        countsByCard[letter] = new Array(DEMO.categories.length).fill(0);
        nByCard[letter] = 0;
      });

      round = {
        mapping,
        probsByCard,
        countsByCard,
        nByCard,
        guessByCard: {A:"",B:"",C:"",D:""},
        revealed: false
      };

      revealNote.textContent = "";
      scoreBox.innerHTML = "";
      buildCards();
      cardLabels.forEach(letter=>renderCard(letter));
    }

    function takeSample(letter){
      const n = Math.max(1, Math.min(500, parseInt(nInput.value,10) || 1));
      const probs = round.probsByCard[letter];

      for(let i=0;i<n;i++){
        const idx = drawCategoryIndex(probs);
        round.countsByCard[letter][idx] += 1;
        round.nByCard[letter] += 1;
      }
      renderCard(letter);
    }

    function clearCard(letter){
      round.countsByCard[letter] = new Array(DEMO.categories.length).fill(0);
      round.nByCard[letter] = 0;
      renderCard(letter);
    }

    function resetSamples(){
      cardLabels.forEach(clearCard);
      scoreBox.innerHTML = "";
    }

    function renderCard(letter){
      const counts = round.countsByCard[letter];
      const N = round.nByCard[letter];

      document.getElementById(`nBadge-${letter}`).textContent = `N = ${N}`;

      // Bar chart
      const div = document.getElementById(`plot-${letter}`);
      Plotly.react(div, [{
        type: 'bar',
        x: DEMO.categories,
        y: counts,
        opacity: 0.85,
        hovertemplate: "%{x}<br>count=%{y}<extra></extra>"
      }], {
        margin: {t: 10, r: 10, b: 35, l: 45},
        xaxis: {tickangle: 0},
        yaxis: {title: "count", rangemode: "tozero"},
        showlegend: false
      }, {responsive:true});

      // Table
      const tbody = document.getElementById(`tbl-${letter}`);
      tbody.innerHTML = "";
      for(let i=0;i<DEMO.categories.length;i++){
        const c = counts[i];
        const pct = (N === 0) ? 0 : (100*c/N);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${escapeHtml(DEMO.categories[i])}</td>
          <td>${c}</td>
          <td>${pct.toFixed(1)}%</td>
        `;
        tbody.appendChild(tr);
      }

      // Reveal label if needed
      const truthEl = document.getElementById(`truth-${letter}`);
      const prof = round.mapping.find(m=>m.card===letter).profile;
      truthEl.innerHTML = `<strong>${escapeHtml(prof.label)}</strong> <span class="muted">(${escapeHtml(prof.hint)})</span>`;
      truthEl.style.display = round.revealed ? "" : "none";
    }

    function reveal(){
      round.revealed = true;
      cardLabels.forEach(renderCard);
      revealNote.innerHTML = `<strong>Revealed.</strong> Use “New round” to reshuffle the cities.`;
    }

    function checkAnswers(){
      let correct = 0;
      const lines = [];

      cardLabels.forEach(letter=>{
        const guess = round.guessByCard[letter];
        const truth = round.mapping.find(m=>m.card===letter).profile.key;
        const ok = (guess && guess === truth);
        if(ok) correct++;
        const guessLabel = DEMO.profiles.find(p=>p.key===guess)?.label || "(no guess)";
        const truthLabel = DEMO.profiles.find(p=>p.key===truth)?.label || "";
        lines.push(`City ${letter}: ${ok ? "✅" : "❌"} guess: ${escapeHtml(guessLabel)} | truth: ${escapeHtml(truthLabel)}`);
      });

      const pct = Math.round((correct/4)*100);
      scoreBox.innerHTML = `
        <div class="status ${correct===4 ? "good" : "bad"}">Score: ${correct}/4 (${pct}%)</div>
        <div class="muted" style="margin-top:8px;line-height:1.5">${lines.join("<br/>")}</div>
      `;
    }

    btnNewRound.addEventListener('click', newRound);
    btnReveal.addEventListener('click', reveal);
    btnCheck.addEventListener('click', checkAnswers);
    btnResetSamples.addEventListener('click', resetSamples);

    newRound();
  </script>
</body>
</html>
