<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>XC Team Scoring Tracker</title>
<style>
  :root{
    --bg:#0f172a; --panel:#0e1626; --panel-2:#0b1220; --muted:#94a3b8; --text:#e5e7eb;
    --accent:#22c55e; --accent-2:#38bdf8; --warn:#f59e0b; --danger:#ef4444; --ring:rgba(56,189,248,.35);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,var(--bg),#0b1020);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Arial,sans-serif}
  h1,h2,h3{margin:0 0 .5rem}
  .wrap{max-width:1100px;margin:0 auto;padding:18px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .grid{display:grid;gap:12px}
  .cols-2{grid-template-columns:1.2fr .8fr}
  @media (max-width:980px){.cols-2{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid #1f2937;border-radius:14px;box-shadow:0 10px 24px rgba(0,0,0,.25)}
  .card>.hd{padding:12px 14px;border-bottom:1px solid #1f2937;display:flex;align-items:center;gap:10px}
  .card>.bd{padding:14px}
  .btn{appearance:none;border:1px solid #263244;background:#0d1626;color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:800;transition:.15s box-shadow,.15s transform}
  .btn:hover{box-shadow:0 0 0 3px var(--ring)}
  .btn:active{transform:translateY(1px)}
  .btn.small{padding:6px 10px;border-radius:10px;font-weight:700}
  .btn.ghost{background:transparent}
  .btn.warn{background:#2a1d05;border-color:#7a4d07;color:#ffd38a}
  .btn.danger{background:#2a0b0b;border-color:#7a1717;color:#ffb3b3}
  .btn.accent{background:#06240f;border-color:#0b5d2c;color:#a9f3c5}
  label{font-size:.9rem;color:var(--muted)}
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #253046;background:#0c1526;color:var(--text)}
  .pill{display:inline-flex;align-items:center;gap:8px;border-radius:999px;padding:6px 10px;border:1px solid #293548;background:#0f1a2a;font-weight:700}
  .pill .dot{width:10px;height:10px;border-radius:50%}
  .teams-area{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:10px}
  .team-btn{display:flex;align-items:center;gap:10px;min-height:56px;border:2px solid #2a3446;border-radius:12px;padding:12px;cursor:pointer;font-weight:900;justify-content:center;font-size:1.05rem;text-shadow:0 1px 2px rgba(0,0,0,.6)}
  .team-btn .swatch{width:18px;height:18px;border-radius:50%;border:2px solid rgba(255,255,255,.7)}
  .list{display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto;padding-right:6px}
  .chip{display:flex;align-items:center;gap:8px;border:1px solid #263244;background:#0d1626;border-radius:999px;padding:6px 10px}
  .chip .badge{font-size:.75rem;opacity:.9;padding:.1rem .5rem;border-radius:999px;border:1px solid #334155}
  .chip .idx{opacity:.85;font-weight:800;padding:.15rem .55rem;background:#0a1220;border-radius:6px;border:1px solid #273041}
  .chip .move{margin-left:auto;display:flex;gap:6px}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid #1f2937;padding:8px 10px;text-align:left}
  th{color:#c8d4e2;position:sticky;top:0;background:linear-gradient(180deg,#0f172a,#101727);z-index:1}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .right{text-align:right}
  .tag{font-size:.75rem;opacity:.9;padding:.15rem .5rem;border-radius:6px;border:1px solid #334155;background:#0c1526}
  .subtle{color:var(--muted)}
  .sep{height:1px;background:#1f2937;margin:10px 0}
  .note{font-size:.85rem;color:#b6c3d5}
  /* Tabs */
  .tabbar{display:flex;gap:8px;border-bottom:1px solid #1f2937;margin-top:8px}
  .tab{appearance:none;background:transparent;border:1px solid #273041;border-bottom:none;border-top-left-radius:10px;border-top-right-radius:10px;padding:10px 14px;font-weight:900;cursor:pointer;color:#cbd5e1}
  .tab.active{background:#0f1a2a;color:#e5e7eb}
  .hidden{display:none}
</style>
</head>
<body>
<div class="wrap">
  <div class="row" style="justify-content:space-between">
    <h1>XC Team Scoring Tracker</h1>
    <div class="row">
      <button id="exportBtn" class="btn small ghost" title="Export CSV">Export CSV</button>
      <button id="undoBtn" class="btn small warn" title="Undo last finisher">Undo</button>
      <button id="resetBtn" class="btn small danger" title="Clear all data">Reset</button>
    </div>
  </div>

  <div class="tabbar">
    <button class="tab active" data-tab="tabScoring">Scoring</button>
    <button class="tab" data-tab="tabTeams">Teams</button>
  </div>

  <!-- Scoring Tab -->
  <section id="tabScoring">
    <div class="grid cols-2" style="margin-top:10px">
      <section class="card">
        <div class="hd"><strong>Scoring Controls</strong></div>
        <div class="bd grid" style="gap:14px">
          <div class="grid" style="grid-template-columns:1fr 1fr; gap:12px">
            <div>
              <label>Scoring runners (N)</label>
              <input id="inScoring" type="number" min="3" max="10" value="5" />
            </div>
            <div>
              <label>Displacement per team (D)</label>
              <input id="inDisplace" type="number" min="0" max="5" value="2" />
            </div>
          </div>
          <div>
            <label>Tap team as each runner finishes</label>
            <div id="teamButtons" class="teams-area" style="margin-top:8px"></div>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="hd row" style="justify-content:space-between">
          <strong>Finishers (live)</strong>
          <span class="subtle">Use ▲ ▼ to adjust order</span>
        </div>
        <div class="bd">
          <div id="finishList" class="list"></div>
        </div>
      </section>

      <section class="card" style="grid-column:1/-1">
        <div class="hd row" style="justify-content:space-between">
          <strong>Team Scores</strong>
          <span class="subtle">Complete teams displace; score = sum of top N adjusted places.</span>
        </div>
        <div class="bd" style="overflow:auto;max-height:420px">
          <table id="scoreTable">
            <thead>
              <tr>
                <th>Rank</th>
                <th>Team</th>
                <th class="right">Score</th>
                <th>Scoring Places</th>
                <th>6th/7th (TB)</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </section>
    </div>
  </section>

  <!-- Teams Tab -->
  <section id="tabTeams" class="hidden">
    <div class="grid" style="margin-top:10px">
      <section class="card">
        <div class="hd"><strong>Teams Setup</strong></div>
        <div class="bd">
          <div class="grid" style="grid-template-columns: 1fr 160px; gap:10px">
            <input id="teamName" placeholder="New team name (e.g., Tigers)" />
            <input id="teamColor" type="color" value="#ff6600" title="Team color" />
          </div>
          <div class="row" style="margin-top:8px">
            <button id="addTeam" class="btn small accent">Add Team</button>
            <button id="rmAllTeams" class="btn small ghost">Remove All</button>
            <button id="quickSeed" class="btn small ghost" title="Adds a few sample teams">Seed Samples</button>
          </div>
          <div class="sep"></div>
          <div class="note" style="margin-bottom:8px">Current teams (edit inline; ❌ to remove)</div>
          <div id="teamsAdmin" class="row"></div>
        </div>
      </section>
    </div>
  </section>
</div>

<script>
(function(){
  // --- State ---
  var state = {
    N: 5,
    D: 2,
    nextTeamId: 1,
    teams: [],        // {id:number, name:string, color:string}
    finishes: []      // [{teamId:number} ...] in raw finish order
  };

  // --- Helpers ---
  function $(id){ return document.getElementById(id); }

  function bestTextColor(hex){
    if(!hex){ return '#ffffff'; }
    var h = String(hex).replace('#','');
    if(h.length<6){ return '#ffffff'; }
    var r = parseInt(h.substr(0,2),16);
    var g = parseInt(h.substr(2,2),16);
    var b = parseInt(h.substr(4,2),16);
    var yiq = (r*299 + g*587 + b*114)/1000;
    return yiq >= 140 ? '#0b1220' : '#f8fafc';
  }
  function clamp(v,min,max){ v=parseInt(v,10); if(isNaN(v)) v=min; return Math.max(min, Math.min(max, v)); }
  function escapeHtml(s){ return String(s).replace(/[&<>"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c];}); }

  // --- Tabs ---
  function switchTab(tabId){
    var tabs = document.querySelectorAll('.tab');
    for (var i=0;i<tabs.length;i++){
      var b = tabs[i];
      b.classList.toggle('active', b.getAttribute('data-tab')===tabId);
    }
    var sections = document.querySelectorAll('section[id^="tab"]');
    for (var j=0;j<sections.length;j++){ sections[j].classList.add('hidden'); }
    var target = $(tabId);
    if(target){ target.classList.remove('hidden'); }
  }

  // --- Teams ---
  function addTeam(name, color){
    name = (name||'').trim();
    if(!name){ alert('Enter a team name'); return; }
    var t = { id: state.nextTeamId++, name: name, color: color||'#888888' };
    state.teams.push(t);
    renderTeamsBar();
    renderTeamsAdmin();
  }
  function removeTeam(id){
    // Also remove any finishes from this team
    var i;
    var nf=[]; for(i=0;i<state.finishes.length;i++){ if(state.finishes[i].teamId!==id) nf.push(state.finishes[i]); }
    state.finishes = nf;
    var nt=[]; for(i=0;i<state.teams.length;i++){ if(state.teams[i].id!==id) nt.push(state.teams[i]); }
    state.teams = nt;
    renderAll();
  }
  function clearTeams(){
    state.teams = [];
    state.finishes = [];
    renderAll();
  }

  // --- Scoring Logic ---
  function calculate(){
    var N = state.N; var D = state.D;
    var rawCounts = {}; // teamId -> raw finish count
    var i;
    for(i=0;i<state.teams.length;i++){ rawCounts[state.teams[i].id] = 0; }
    for(i=0;i<state.finishes.length;i++){
      var f = state.finishes[i];
      rawCounts[f.teamId] = (rawCounts[f.teamId]||0)+1;
    }
    function eligible(teamId){ return (rawCounts[teamId]||0) >= N; }

    // Within-team index as we traverse raw order
    var within = {}; // teamId -> k
    var adjusted = []; // elements: {rawIndex, teamId, role:'scorer'|'displacer'} (others skipped)
    var roles = [];    // per raw index: string role

    for(i=0;i<state.finishes.length;i++){
      var fin = state.finishes[i];
      var tid = fin.teamId;
      var k = (within[tid]||0) + 1;
      within[tid] = k;

      if(!eligible(tid)){
        roles[i] = 'no-displace (incomplete team)';
        continue; // no adjust
      }
      if(k <= N){
        adjusted.push({rawIndex:i, teamId:tid, role:'scorer'});
        roles[i] = 'scorer';
      } else if(k <= N + D){
        adjusted.push({rawIndex:i, teamId:tid, role:'displacer'});
        roles[i] = 'displacer';
      } else {
        roles[i] = 'non-displacing (>N+D)';
      }
    }

    // adjusted already in raw order; its adjusted place is index+1
    // Build per-team adjusted place arrays
    var teamAdj = {}; // teamId -> [adjusted places]
    for(i=0;i<adjusted.length;i++){
      var ap = i+1;
      var a = adjusted[i];
      if(!teamAdj[a.teamId]) teamAdj[a.teamId] = [];
      teamAdj[a.teamId].push(ap);
    }

    // Build score rows
    var rows = [];
    for(i=0;i<state.teams.length;i++){
      var t = state.teams[i];
      var adjArr = teamAdj[t.id] || [];
      var count = rawCounts[t.id] || 0;
      var incomplete = count < N;
      var scoringPlaces = adjArr.slice(0, N);
      var score = null; var j;
      if(!incomplete && scoringPlaces.length===N){
        score = 0; for(j=0;j<scoringPlaces.length;j++){ score += scoringPlaces[j]; }
      }
      var tieBreakers = adjArr.slice(N, N+3); // show a few
      rows.push({ teamId:t.id, score:score, scoringPlaces:scoringPlaces, tieBreakers:tieBreakers, incomplete:incomplete, count:count });
    }

    // Rank complete teams by score then tieBreakers
    var complete = [];
    for(i=0;i<rows.length;i++){ if(!rows[i].incomplete && rows[i].score!==null) complete.push(rows[i]); }
    complete.sort(function(a,b){
      if(a.score!==b.score) return a.score-b.score;
      var m = Math.max(a.tieBreakers.length, b.tieBreakers.length);
      var k;
      for(k=0;k<m;k++){
        var av = (k<a.tieBreakers.length)?a.tieBreakers[k]:Infinity;
        var bv = (k<b.tieBreakers.length)?b.tieBreakers[k]:Infinity;
        if(av!==bv) return av-bv;
      }
      return 0;
    });

    // Append incomplete/unranked (original team order)
    var ranked = {}; for(i=0;i<complete.length;i++){ ranked[complete[i].teamId]=true; }
    var finalRows = complete.slice();
    for(i=0;i<rows.length;i++){ if(!ranked[rows[i].teamId]) finalRows.push(rows[i]); }

    return {
      adjusted: adjusted,
      roles: roles,
      rows: finalRows
    };
  }

  // --- Renderers ---
  function renderTeamsBar(){
    var root = $('teamButtons'); if(!root) return; root.innerHTML='';
    for(var i=0;i<state.teams.length;i++){
      var t = state.teams[i];
      var btn = document.createElement('button');
      btn.className = 'team-btn';
      btn.style.background = (t.color||'#446') + '30';
      btn.style.borderColor = t.color||'#446';
      btn.style.color = bestTextColor(t.color||'#446');
      btn.innerHTML = '<span class="swatch" style="background:'+t.color+'"></span> <span>'+escapeHtml(t.name)+'</span>';
      (function(teamId){ btn.addEventListener('click', function(){
        state.finishes.push({teamId:teamId});
        renderAll();
      }); })(t.id);
      root.appendChild(btn);
    }
  }

  function renderTeamsAdmin(){
    var admin = $('teamsAdmin'); if(!admin) return; admin.innerHTML='';
    for(var i=0;i<state.teams.length;i++){
      (function(t){
        var wrap = document.createElement('div');
        wrap.className = 'pill';
        wrap.style.gap = '6px';
        wrap.innerHTML = ''+
          '<span class="dot" style="background:'+t.color+'"></span>'+
          '<input type="color" value="'+t.color+'" style="width:36px;height:28px;padding:0;border-radius:8px;border:1px solid #334155;background:#0c1526">'+
          '<input value="'+escapeHtml(t.name)+'" style="min-width:120px;background:#0c1526;border:1px solid #334155;color:#e5e7eb;border-radius:8px;padding:6px 8px">'+
          '<button class="btn small danger" title="Remove">❌</button>';
        var inputs = wrap.getElementsByTagName('input');
        var colorInput = inputs[0];
        var nameInput = inputs[1];
        var delBtn = wrap.getElementsByTagName('button')[0];
        colorInput.addEventListener('input', function(){ t.color = colorInput.value; renderTeamsBar(); renderAll(); });
        nameInput.addEventListener('change', function(){ t.name = nameInput.value.trim()||t.name; renderTeamsBar(); renderAll(); });
        delBtn.addEventListener('click', function(){ removeTeam(t.id); });
        admin.appendChild(wrap);
      })(state.teams[i]);
    }
  }

  function renderFinishList(calc){
    var list = $('finishList'); if(!list) return; list.innerHTML='';
    var i;
    var roleByIndex = {}; // rawIndex -> {adjPlace:number, role:string}
    for(i=0;i<calc.adjusted.length;i++){
      var it = calc.adjusted[i];
      roleByIndex[it.rawIndex] = { adjPlace: i+1, role: it.role };
    }

    for(i=0;i<state.finishes.length;i++){
      (function(rawIdx){
        var f = state.finishes[rawIdx];
        var team = null; for(var k=0;k<state.teams.length;k++){ if(state.teams[k].id===f.teamId){ team=state.teams[k]; break; } }
        var info = roleByIndex[rawIdx];
        var adj = info?info.adjPlace:'…';
        var role = info?info.role:'pending';
        var row = document.createElement('div');
        row.className = 'chip';
        var teamColor = team?team.color:'#64748b';
        var teamName = team?escapeHtml(team.name):'Unknown';
        row.innerHTML =
          '<span class="idx">'+(rawIdx+1)+'</span>'+
          '<span class="pill"><span class="dot" style="background:'+teamColor+'"></span>'+teamName+'</span>'+
          '<span class="badge">'+role+'</span>'+
          '<span class="tag">adj: '+adj+'</span>'+
          '<span class="move">'+
            '<button class="btn small" title="Move up">▲<\/button>'+
            '<button class="btn small" title="Move down">▼<\/button>'+
          '<\/span>';
        var btns = row.getElementsByTagName('button');
        var upBtn = btns[0]; var downBtn = btns[1];
        upBtn.addEventListener('click', function(){ moveFinish(rawIdx,-1); });
        downBtn.addEventListener('click', function(){ moveFinish(rawIdx,+1); });
        list.appendChild(row);
      })(i);
    }
  }

  function renderScores(calc){
    var st = $('scoreTable'); if(!st) return; var tbody = st.getElementsByTagName('tbody')[0];
    tbody.innerHTML='';
    if(calc.rows.length===0){
      var tr0 = document.createElement('tr');
      var td0 = document.createElement('td'); td0.colSpan=6; td0.className='subtle'; td0.appendChild(document.createTextNode('No team scores yet. Add finishers to begin.'));
      tr0.appendChild(td0); tbody.appendChild(tr0); return;
    }
    for(var i=0;i<calc.rows.length;i++){
      var r = calc.rows[i];
      var tr = document.createElement('tr');
      var team = null; for(var k=0;k<state.teams.length;k++){ if(state.teams[k].id===r.teamId){ team=state.teams[k]; break; } }
      var rank = r.incomplete ? '—' : (i+1);
      var places = r.scoringPlaces.length ? r.scoringPlaces.join(', ') : '—';
      var tie = r.tieBreakers.length ? r.tieBreakers.join(', ') : '—';
      var status = r.incomplete ? ('Incomplete ('+r.count+'/'+state.N+')') : 'Complete';
      tr.innerHTML = ''+
        '<td>'+rank+'</td>'+
        '<td><span class="pill"><span class="dot" style="background:'+(team?team.color:'#64748b')+'"></span>'+(team?escapeHtml(team.name):'Unknown')+'</span></td>'+
        '<td class="right mono">'+(r.score===null?'—':r.score)+'</td>'+
        '<td class="mono">'+places+'</td>'+
        '<td class="mono">'+tie+'</td>'+
        '<td>'+status+'</td>';
      tbody.appendChild(tr);
    }
  }

  function renderAll(){
    // inputs
    $('inScoring').value = state.N;
    $('inDisplace').value = state.D;

    // compute
    var calc = calculate();
    renderTeamsBar();
    renderTeamsAdmin();
    renderFinishList(calc);
    renderScores(calc);
  }

  // --- Mutations ---
  function moveFinish(idx, delta){
    var j = idx + delta; if(j<0 || j>=state.finishes.length) return;
    var tmp = state.finishes[idx]; state.finishes[idx] = state.finishes[j]; state.finishes[j] = tmp;
    renderAll();
  }

  // --- Export ---
  function exportCsv(){
    var calc = calculate();
    var lines = [];
    lines.push('XC Team Scoring Export');
    lines.push('Scoring N,'+state.N);
    lines.push('Displacement D,'+state.D);
    lines.push('');

    lines.push('Finish List');
    lines.push('Raw Place,Team,Adjusted Place,Role');
    var i;
    var roleByIndex = {}; for(i=0;i<calc.adjusted.length;i++){ roleByIndex[calc.adjusted[i].rawIndex] = i+1; }
    for(i=0;i<state.finishes.length;i++){
      var f = state.finishes[i];
      var t=null; for(var k=0;k<state.teams.length;k++){ if(state.teams[k].id===f.teamId){ t=state.teams[k]; break; } }
      var adj = (roleByIndex[i]||'');
      var role = 'pending';
      // re-derive role quickly
      for(var a=0;a<calc.adjusted.length;a++){ if(calc.adjusted[a].rawIndex===i){ role = calc.adjusted[a].role; break; } }
      lines.push([i+1, t?t.name:'', adj, role].join(','));
    }

    lines.push(''); lines.push('Team Scores');
    lines.push('Rank,Team,Score,Scoring Places,6th/7th (TB),Status');
    for(i=0;i<calc.rows.length;i++){
      var r = calc.rows[i];
      var team=null; for(var k=0;k<state.teams.length;k++){ if(state.teams[k].id===r.teamId){ team=state.teams[k]; break; } }
      var rank = r.incomplete ? '' : (i+1);
      var places = r.scoringPlaces.length ? r.scoringPlaces.join(' ') : '';
      var tie = r.tieBreakers.length ? r.tieBreakers.join(' ') : '';
      var status = r.incomplete ? ('Incomplete ('+r.count+'/'+state.N+')') : 'Complete';
      var score = (r.score===null?'':r.score);
      lines.push([rank, team?team.name:'', score, places, tie, status].join(','));
    }

    var blob = new Blob([lines.join('\n')], {type:'text/csv'});
    var url = URL.createObjectURL(blob);
    var a = document.createElement('a'); a.href = url; a.download = 'xc_scoring_export.csv';
    document.body.appendChild(a); a.click();
    setTimeout(function(){ URL.revokeObjectURL(url); a.remove(); }, 400);
  }

  // --- Wireup ---
  window.addEventListener('DOMContentLoaded', function(){
    // Tabs
    var tabBtns = document.querySelectorAll('.tab');
    for(var i=0;i<tabBtns.length;i++){
      (function(btn){ btn.addEventListener('click', function(){ switchTab(btn.getAttribute('data-tab')); }); })(tabBtns[i]);
    }

    // Inputs
    $('inScoring').addEventListener('change', function(e){ state.N = clamp(e.target.value,1,10); e.target.value=state.N; renderAll(); });
    $('inDisplace').addEventListener('change', function(e){ state.D = clamp(e.target.value,0,10); e.target.value=state.D; renderAll(); });

    // Top buttons
    $('exportBtn').addEventListener('click', exportCsv);
    $('undoBtn').addEventListener('click', function(){ state.finishes.pop(); renderAll(); });
    $('resetBtn').addEventListener('click', function(){ if(confirm('Clear all finishers and scores?')){ state.finishes=[]; renderAll(); }});

    // Teams tab controls
    $('addTeam').addEventListener('click', function(){ addTeam($('teamName').value, $('teamColor').value); $('teamName').value=''; });
    $('rmAllTeams').addEventListener('click', function(){ if(confirm('Remove all teams and finishes?')) clearTeams(); });
    $('quickSeed').addEventListener('click', function(){
      addTeam('Tigers','#ff6600');
      addTeam('Reds','#c6011f');
      addTeam('Bulldogs','#3b82f6');
      addTeam('Eagles','#22c55e');
    });

    renderAll();
  });
})();
</script>
</body>
</html>
