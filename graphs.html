<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Excel → Charts (Pie / Bar / Histogram)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- SheetJS for reading Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for plotting -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root { --bg:#0f172a; --panel:#111827; --card:#1f2937; --text:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; }
    body { margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--text); }
    .wrap { max-width:1100px; margin:32px auto; padding:0 16px; }
    h1 { font-size:1.6rem; margin:0 0 16px; letter-spacing:.2px; }
    .panel { background:var(--panel); border:1px solid #222; border-radius:14px; padding:16px; display:grid; gap:12px; grid-template-columns:1fr 1fr; }
    .panel > div { background:var(--card); border-radius:12px; padding:14px; }
    .row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    label { font-size:.95rem; color:var(--muted); }
    input[type="file"] { color:var(--text); }
    select, input[type="number"] {
      background:#111827; color:var(--text); border:1px solid #30363d; border-radius:8px; padding:8px 10px; min-width:180px;
    }
    button {
      appearance:none; border:1px solid #2a2f3a; background:#0b1220; color:var(--text);
      padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;
    }
    button.primary { background:var(--accent); color:#082f49; border-color:#1d4ed8; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    .hint { font-size:.9rem; color:var(--muted); }
    .full { grid-column:1 / -1; }
    #chartCard { min-height:420px; display:flex; align-items:center; justify-content:center; }
    #messages { white-space:pre-line; font-size:.95rem; color:#f8d66d; }
    .badge { display:inline-block; font-size:.8rem; background:#0b1323; border:1px solid #2a2f3a; padding:4px 8px; border-radius:999px; color:#8ab4ff; }
    .spacer { height:4px; }
    .small { font-size:.85rem; color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Excel → Charts (Pie / Bar / Histogram)</h1>
    <div class="panel">
      <div class="full">
        <div class="row">
          <div class="row" style="gap:8px;">
            <label for="file">1) Choose Excel file (.xlsx):</label>
            <input id="file" type="file" accept=".xlsx,.xls" />
          </div>
          <button id="loadBtn" class="primary">Load Data</button>
          <span id="fileInfo" class="hint"></span>
        </div>
        <div id="messages" class="spacer"></div>
        <div class="row">
          <span class="badge" id="sheetBadge" title="First sheet is used">Sheet: 1</span>
          <span class="badge" id="rowsBadge">Rows: 0</span>
          <span class="badge" id="colsBadge">Columns: 0</span>
        </div>
      </div>

      <div>
        <div class="row">
          <label for="chartType">2) Chart type:</label>
          <select id="chartType">
            <option value="bar">Bar (counts by category)</option>
            <option value="pie">Pie (counts by category)</option>
            <option value="hist">Histogram (numeric only)</option>
          </select>
        </div>
        <div class="row">
          <label for="columnSelect">3) Variable (column):</label>
          <select id="columnSelect" disabled>
            <option value="" disabled selected>Load data first</option>
          </select>
        </div>
        <div id="histOptions" class="row" style="display:none;">
          <label for="bins">Bins:</label>
          <input id="bins" type="number" min="2" max="60" step="1" value="10" />
          <span class="small">(Shown only for Histogram)</span>
        </div>
        <div class="row">
          <button id="drawBtn" disabled class="primary">Draw Chart</button>
          <button id="clearBtn" disabled>Clear Chart</button>
        </div>
        <div class="hint">
          Tip: Histogram requires a numeric column. Pie/Bar work best with categorical columns (few unique values).
        </div>
      </div>

      <div id="chartCard" class="full">
        <canvas id="chartCanvas"></canvas>
      </div>
    </div>
  </div>

  <script>
    let workbookData = null;
    let currentChart = null;

    const els = {
      file: document.getElementById('file'),
      loadBtn: document.getElementById('loadBtn'),
      fileInfo: document.getElementById('fileInfo'),
      chartType: document.getElementById('chartType'),
      columnSelect: document.getElementById('columnSelect'),
      drawBtn: document.getElementById('drawBtn'),
      clearBtn: document.getElementById('clearBtn'),
      messages: document.getElementById('messages'),
      bins: document.getElementById('bins'),
      histOptions: document.getElementById('histOptions'),
      rowsBadge: document.getElementById('rowsBadge'),
      colsBadge: document.getElementById('colsBadge'),
      sheetBadge: document.getElementById('sheetBadge'),
      canvas: document.getElementById('chartCanvas'),
    };

    function showMsg(text) { els.messages.textContent = text || ''; }
    function sanitizeCell(v) {
      if (v === null || v === undefined) return null;
      if (typeof v === 'string') {
        const s = v.trim();
        return s === '' ? null : s;
      }
      return v;
    }
    function isNumericArray(arr) {
      let count = 0, n = 0;
      for (const v of arr) {
        if (v === null) continue;
        n++;
        if (typeof v === 'number' && Number.isFinite(v)) count++;
        else if (typeof v === 'string' && v.trim() !== '' && !isNaN(Number(v))) count++;
      }
      return n > 0 && count / n >= 0.9;
    }
    function toNumericArray(arr) {
      const out = [];
      for (const v of arr) {
        if (v === null) continue;
        const num = typeof v === 'number' ? v : Number(String(v).trim());
        if (Number.isFinite(num)) out.push(num);
      }
      return out;
    }
    function uniqueCounts(arr, {limit=50}={}) {
      const counts = new Map();
      for (const v of arr) {
        if (v === null) continue;
        const key = String(v);
        counts.set(key, (counts.get(key) || 0) + 1);
      }
      const entries = Array.from(counts.entries()).sort((a,b)=> b[1]-a[1]);
      const tooMany = entries.length > limit;
      return { entries: tooMany ? entries.slice(0, limit) : entries, totalUnique: entries.length, truncated: tooMany };
    }
    function sturgesBins(n) { return Math.max(2, Math.ceil(Math.log2(n)) + 1); }
    function computeHistogram(values, binCount) {
      if (values.length === 0) return { labels: [], counts: [] };
      const min = Math.min(...values);
      const max = Math.max(...values);
      if (min === max) { return { labels: [`${min}`], counts: [values.length] }; }
      const k = binCount || sturgesBins(values.length);
      const width = (max - min) / k;
      const counts = Array.from({length:k}, _=>0);
      for (const x of values) {
        let idx = Math.floor((x - min) / width);
        if (idx >= k) idx = k - 1;
        counts[idx]++;
      }
      const labels = counts.map((_,i)=>{
        const a = min + i*width;
        const b = min + (i+1)*width;
        return `[${round(a)}, ${round(b)}${i===k-1?']':')'}`;
      });
      return { labels, counts };
    }
    function round(x) {
      const abs = Math.abs(x);
      const places = abs >= 100 ? 0 : abs >= 10 ? 1 : 2;
      return Number(x.toFixed(places));
    }
    function destroyChart() {
      if (currentChart) { currentChart.destroy(); currentChart = null; }
    }

    els.loadBtn.addEventListener('click', async () => {
      destroyChart(); showMsg(''); workbookData = null;
      els.columnSelect.innerHTML = '<option value="" disabled selected>Loading…</option>';
      els.columnSelect.disabled = true; els.drawBtn.disabled = true; els.clearBtn.disabled = true;

      const file = els.file.files?.[0];
      if (!file) { showMsg('Please choose an Excel file first.'); return; }

      els.fileInfo.textContent = `Selected: ${file.name}`;
      try {
        const ab = await file.arrayBuffer();
        const wb = XLSX.read(ab, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
        if (!rows || rows.length < 2) {
          showMsg('No data found.'); return;
        }
        const headers = rows[0].map(h => String(h ?? '').trim());
        const dataRows = rows.slice(1);
        const columns = {};
        for (let c = 0; c < headers.length; c++) {
          const name = headers[c] || `Column ${c+1}`;
          const col = [];
          for (let r = 0; r < dataRows.length; r++) {
            const val = sanitizeCell(dataRows[r][c]);
            col.push(val);
          }
          columns[name] = col;
        }
        workbookData = { headers, columns, nRows: dataRows.length };

        els.columnSelect.innerHTML = '';
        for (const h of headers) {
          const opt = document.createElement('option');
          const col = columns[h];
          const numeric = isNumericArray(col);
          opt.value = h;
          opt.textContent = numeric ? `${h} (numeric)` : h;
          opt.dataset.type = numeric ? 'numeric' : 'categorical';
          els.columnSelect.appendChild(opt);
        }
        els.columnSelect.disabled = false;
        els.drawBtn.disabled = false;
        els.clearBtn.disabled = false;

        els.sheetBadge.textContent = 'Sheet: 1';
        els.rowsBadge.textContent = `Rows: ${workbookData.nRows}`;
        els.colsBadge.textContent = `Columns: ${headers.length}`;
        updateControlsVisibility();
        showMsg('Data loaded. Pick a chart type and column.');
      } catch (err) {
        console.error(err); showMsg('Failed to read the Excel file.');
      }
    });

    els.chartType.addEventListener('change', updateControlsVisibility);
    function updateControlsVisibility() {
      const isHist = els.chartType.value === 'hist';
      els.histOptions.style.display = isHist ? 'flex' : 'none';
    }

    els.clearBtn.addEventListener('click', () => { destroyChart(); showMsg('Chart cleared.'); });

    els.drawBtn.addEventListener('click', () => {
      showMsg('');
      if (!workbookData) { showMsg('Please load data first.'); return; }
      const colName = els.columnSelect.value;
      if (!colName) { showMsg('Please select a column.'); return; }
      const chartType = els.chartType.value;
      const rawCol = workbookData.columns[colName];
      destroyChart();

      if (chartType === 'hist') {
        if (!isNumericArray(rawCol)) { showMsg('Histogram requires numeric.'); return; }
        const values = toNumericArray(rawCol);
        const bins = Math.max(2, Math.min(60, parseInt(els.bins.value || '10', 10)));
        const { labels, counts } = computeHistogram(values, bins);
        drawChart('bar', labels, counts, {
          title: `${colName} — Histogram (${bins} bins)`,
          xLabel: colName, yLabel: 'Frequency', isHistogram: true
        });
      } else {
        const cleaned = rawCol.map(v => v === null ? null : String(v).trim()).filter(v => v !== null && v !== '');
        const { entries, totalUnique } = uniqueCounts(cleaned, { limit: 30 });
        if (totalUnique > 30) showMsg(`Showing top 30 of ${totalUnique} unique values.`);
        const labels = entries.map(e => e[0]);
        const counts = entries.map(e => e[1]);
        drawChart(chartType, labels, counts, {
          title: `${colName} — ${chartType === 'pie' ? 'Pie' : 'Bar'} Chart`,
          xLabel: 'Category', yLabel: 'Count'
        });
      }
    });

    function drawChart(kind, labels, data, meta) {
      const ctx = els.canvas.getContext('2d');
      const isPie = (kind === 'pie');
      const isHist = !!meta?.isHistogram;

      // For histograms, provide (x,y) points on a linear x-scale with unit spacing.
      const dataset = {
        label: meta?.yLabel || 'Value',
        data: isHist ? data.map((y, i) => ({ x: i, y })) : data,
        parsing: !isHist,             // use {x,y} directly for hist
        borderWidth: isHist ? 0 : 1,  // no borders on hist bars
        barPercentage: 1.0,
        categoryPercentage: 1.0,
        // You can uncomment the next line to force a fixed pixel width if desired:
        // barThickness: isHist ? undefined : undefined
      };

      const options = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: { display: !!meta?.title, text: meta?.title },
          legend: { display: isPie, position: 'bottom' },
          tooltip: isHist ? {
            callbacks: {
              title: (items) => {
                const i = items?.[0]?.raw?.x ?? 0;
                return labels[i] ?? '';
              }
            }
          } : {}
        },
        elements: {
          bar: { borderSkipped: false } // solid rectangles
        },
        scales: isPie ? {} : {
          x: isHist ? {
            type: 'linear',
            min: -0.5,                       // ensures first/last bars have full width
            max: data.length - 0.5,
            offset: false,
            grid: { display: false, drawBorder: false },
            title: { display: !!meta?.xLabel, text: meta?.xLabel },
            ticks: {
              stepSize: 1,
              autoSkip: false,
              maxRotation: 45,
              minRotation: 0,
              callback: (value) => {
                // value is numeric (0..k-1); map to bin range label
                return Number.isInteger(value) ? (labels[value] ?? '') : '';
              }
            }
          } : {
            title: { display: !!meta?.xLabel, text: meta?.xLabel },
            ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 }
          },
          y: {
            title: { display: !!meta?.yLabel, text: meta?.yLabel },
            beginAtZero: true,
            precision: 0
          }
        }
      };

      currentChart = new Chart(ctx, {
        type: isPie ? 'pie' : 'bar',
        data: isHist ? { datasets: [dataset] } : { labels, datasets: [dataset] },
        options
      });
    }
  </script>
</body>
</html>
